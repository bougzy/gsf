<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSAMS - GeoSecure Attendance Management System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <!-- QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        /* All existing CSS styles remain the same */
        /* ... (Keep all existing CSS styles) ... */
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <!-- Home Page -->
    <div id="homePage">
        <!-- Keep all existing home page content -->
        <!-- ... (Keep all existing home page content) ... -->
    </div>

    <!-- Register Page -->
    <div id="registerPage" class="auth-container" style="display: none;">
        <!-- Keep all existing register page content -->
        <!-- ... (Keep all existing register page content) ... -->
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="auth-container" style="display: none;">
        <!-- Keep all existing login page content -->
        <!-- ... (Keep all existing login page content) ... -->
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Keep all existing dashboard structure -->
        <!-- ... (Keep all existing dashboard structure) ... -->
    </div>

    <!-- Modals -->
    
    <!-- Create Meeting Modal -->
    <div class="modal fade" id="createMeetingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">Create New Meeting</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="meetingTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">Meeting Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="form-tab" data-bs-toggle="tab" data-bs-target="#form" type="button" role="tab">Attendance Form</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sharing-tab" data-bs-toggle="tab" data-bs-target="#sharing" type="button" role="tab">Share & QR Code</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">Advanced Settings</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-4" id="meetingTabsContent">
                        <!-- Tab 1: Meeting Details -->
                        <div class="tab-pane fade show active" id="details" role="tabpanel">
                            <form id="createMeetingForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meeting Title *</label>
                                        <input type="text" class="form-control" id="meetingTitle" required placeholder="Enter meeting title">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location Name *</label>
                                        <input type="text" class="form-control" id="meetingLocationName" required placeholder="Enter location name">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="meetingDescription" rows="3" placeholder="Enter meeting description"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Start Date & Time *</label>
                                        <input type="datetime-local" class="form-control" id="meetingStartTime" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">End Date & Time *</label>
                                        <input type="datetime-local" class="form-control" id="meetingEndTime" required>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Latitude *</label>
                                        <input type="number" step="any" class="form-control" id="meetingLatitude" required value="40.7128" placeholder="40.7128">
                                        <small class="text-muted">Placeholder: New York City latitude</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Longitude *</label>
                                        <input type="number" step="any" class="form-control" id="meetingLongitude" required value="-74.0060" placeholder="-74.0060">
                                        <small class="text-muted">Placeholder: New York City longitude</small>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Location Radius (meters) *</label>
                                    <input type="number" class="form-control" id="meetingRadius" value="100" min="10" max="1000" required>
                                    <small class="text-muted">Users must be within this radius to attend</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Location Address (Optional)</label>
                                    <input type="text" class="form-control" id="meetingAddress" placeholder="Enter full address">
                                </div>
                            </form>
                        </div>
                        
                        <!-- Tab 2: Form Builder -->
                        <div class="tab-pane fade" id="form" role="tabpanel">
                            <div class="form-builder-container">
                                <div class="form-check mb-4">
                                    <input class="form-check-input" type="checkbox" id="requireForm">
                                    <label class="form-check-label" for="requireForm">
                                        <strong>Require attendees to fill this form</strong>
                                    </label>
                                </div>
                                
                                <h5 class="mb-4">Custom Attendance Form Builder</h5>
                                <p class="text-muted mb-4">Add custom fields that attendees will fill when joining the meeting.</p>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-4">
                                            <h6>Form Fields</h6>
                                            <div id="formFieldsList">
                                                <div class="alert alert-info">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    No fields added yet. Click "Add Field" to create your first form field.
                                                </div>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <button type="button" class="btn btn-outline-custom" onclick="addFormField()">
                                                    <i class="fas fa-plus me-2"></i> Add Field
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" onclick="addDefaultFields()">
                                                    <i class="fas fa-magic me-2"></i> Add Default Fields
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="preview-form">
                                            <h6>Form Preview</h6>
                                            <div id="formPreview">
                                                <p class="text-muted small">Form preview will appear here</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 3: Sharing & QR Code -->
                        <div class="tab-pane fade" id="sharing" role="tabpanel">
                            <div class="share-section">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Share links and QR code will be generated after meeting creation
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="share-link-container">
                                            <h6><i class="fas fa-link me-2"></i> Meeting Link</h6>
                                            <p class="text-muted small mb-3">Share this link with attendees to join the meeting:</p>
                                            <div class="share-link" id="generatedLink">
                                                <span class="text-muted">Link will be generated after meeting creation</span>
                                            </div>
                                            <div class="mt-3 d-flex gap-2">
                                                <button class="btn btn-sm btn-primary-custom" onclick="copyMeetingLink()" id="copyLinkBtn" disabled>
                                                    <i class="fas fa-copy me-1"></i> Copy Link
                                                </button>
                                                <button class="btn btn-sm btn-outline-custom" onclick="testMeetingLink()" id="testLinkBtn" disabled>
                                                    <i class="fas fa-external-link-alt me-1"></i> Test Link
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="qr-code-container">
                                            <h6><i class="fas fa-qrcode me-2"></i> QR Code</h6>
                                            <p class="text-muted small mb-3">Scan this code to join the meeting:</p>
                                            <div id="qrCodeCanvas" class="d-flex justify-content-center">
                                                <div class="text-center">
                                                    <i class="fas fa-qrcode fa-4x text-muted mb-2"></i>
                                                    <p class="small text-muted">QR code will be generated<br>after meeting creation</p>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <button class="btn btn-sm btn-primary-custom" onclick="downloadQRCode()" id="downloadQRBtn" disabled>
                                                    <i class="fas fa-download me-1"></i> Download QR Code
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <h6><i class="fas fa-share-alt me-2"></i> Share via</h6>
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-sm btn-outline-primary" onclick="shareViaEmail()" id="shareEmailBtn" disabled>
                                            <i class="fas fa-envelope me-1"></i> Email
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="shareViaWhatsApp()" id="shareWhatsAppBtn" disabled>
                                            <i class="fab fa-whatsapp me-1"></i> WhatsApp
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="shareViaSMS()" id="shareSMSBtn" disabled>
                                            <i class="fas fa-sms me-1"></i> SMS
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab 4: Advanced Settings -->
                        <div class="tab-pane fade" id="advanced" role="tabpanel">
                            <div class="form-builder-container">
                                <h5 class="mb-4">Advanced Meeting Settings</h5>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6>Attendance Methods</h6>
                                            <p class="text-muted small mb-3">Select which methods attendees can use to check in:</p>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allowGPSMeeting" checked>
                                                <label class="form-check-label" for="allowGPSMeeting">
                                                    <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                                    Smartphone GPS
                                                </label>
                                                <small class="text-muted d-block ms-4">Requires location permission</small>
                                            </div>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allowSMSMeeting" checked>
                                                <label class="form-check-label" for="allowSMSMeeting">
                                                    <i class="fas fa-sms me-2 text-info"></i>
                                                    SMS
                                                </label>
                                                <small class="text-muted d-block ms-4">Format: ATTEND [CODE] [NAME]</small>
                                            </div>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allowUSSDMeeting" checked>
                                                <label class="form-check-label" for="allowUSSDMeeting">
                                                    <i class="fas fa-mobile-alt me-2 text-warning"></i>
                                                    USSD
                                                </label>
                                                <small class="text-muted d-block ms-4">Interactive menu system</small>
                                            </div>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allowKioskMeeting" checked>
                                                <label class="form-check-label" for="allowKioskMeeting">
                                                    <i class="fas fa-desktop me-2 text-secondary"></i>
                                                    Kiosk
                                                </label>
                                                <small class="text-muted d-block ms-4">Admin-assisted check-in station</small>
                                            </div>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" id="allowManualMeeting" checked>
                                                <label class="form-check-label" for="allowManualMeeting">
                                                    <i class="fas fa-user-check me-2 text-success"></i>
                                                    Manual
                                                </label>
                                                <small class="text-muted d-block ms-4">Admin manual verification</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6>Verification Settings</h6>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Verification Strictness</label>
                                                <select class="form-select" id="verificationStrictness">
                                                    <option value="low">Low - Lenient verification</option>
                                                    <option value="medium" selected>Medium - Standard verification</option>
                                                    <option value="high">High - Strict verification</option>
                                                </select>
                                                <small class="text-muted">Controls how strictly attendance is verified</small>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Duplicate Prevention</label>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="preventSameDevice" checked>
                                                    <label class="form-check-label" for="preventSameDevice">
                                                        Prevent same device
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="preventSamePhone" checked>
                                                    <label class="form-check-label" for="preventSamePhone">
                                                        Prevent same phone number
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="preventSameNameTime" checked>
                                                    <label class="form-check-label" for="preventSameNameTime">
                                                        Prevent same name within time window
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Time Window (minutes)</label>
                                                <input type="number" class="form-control" id="duplicateTimeWindow" value="5" min="1" max="60">
                                                <small class="text-muted">Time window for duplicate prevention</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6>Time Verification</h6>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="requireMinimumStay">
                                                <label class="form-check-label" for="requireMinimumStay">
                                                    Require minimum stay duration
                                                </label>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Minimum Stay (minutes)</label>
                                                <input type="number" class="form-control" id="minimumStayMinutes" value="5" min="1" max="120" disabled>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="enableContinuousMonitoring">
                                                <label class="form-check-label" for="enableContinuousMonitoring">
                                                    Enable continuous monitoring
                                                </label>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">Monitoring Interval (minutes)</label>
                                                <input type="number" class="form-control" id="monitoringInterval" value="5" min="1" max="30" disabled>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6>PWA Settings</h6>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="checkbox" id="enablePWA" checked>
                                                <label class="form-check-label" for="enablePWA">
                                                    Enable Progressive Web App
                                                </label>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label class="form-label">App Name</label>
                                                <input type="text" class="form-control" id="appName" value="GSAMS Attendance">
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Theme Color</label>
                                                    <input type="color" class="form-control form-control-color" id="themeColor" value="#2196F3">
                                                </div>
                                                <div class="col-md-6 mb-3">
                                                    <label class="form-label">Background Color</label>
                                                    <input type="color" class="form-control form-control-color" id="backgroundColor" value="#ffffff">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <button type="button" class="btn btn-outline-secondary" onclick="prevTab()" id="prevTabBtn">
                                <i class="fas fa-arrow-left me-2"></i> Previous
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="nextTab()" id="nextTabBtn">
                                Next <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary-custom" onclick="createMeeting()" id="createMeetingBtn">
                                <i class="fas fa-calendar-plus me-2"></i> Create Meeting
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meeting Success Modal -->
    <div class="modal fade" id="meetingSuccessModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i> Meeting Created Successfully!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                        <h4 id="successMeetingTitle"></h4>
                        <p class="text-muted">Meeting has been created and is ready to share</p>
                    </div>
                    
                    <div class="share-section">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="share-link-container">
                                    <h6><i class="fas fa-link me-2"></i> Meeting Link</h6>
                                    <p class="text-muted small mb-3">Share this link with attendees:</p>
                                    <div class="share-link" id="successGeneratedLink">
                                        <span class="text-muted">Loading...</span>
                                    </div>
                                    <div class="mt-3 d-flex gap-2">
                                        <button class="btn btn-sm btn-primary-custom" onclick="copySuccessMeetingLink()">
                                            <i class="fas fa-copy me-1"></i> Copy Link
                                        </button>
                                        <button class="btn btn-sm btn-outline-custom" onclick="testSuccessMeetingLink()">
                                            <i class="fas fa-external-link-alt me-1"></i> Test Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="qr-code-container">
                                    <h6><i class="fas fa-qrcode me-2"></i> QR Code</h6>
                                    <p class="text-muted small mb-3">Scan to join:</p>
                                    <div id="successQrCodeCanvas"></div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary-custom" onclick="downloadSuccessQRCode()">
                                            <i class="fas fa-download me-1"></i> Download QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-key me-2"></i> Access Codes
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6>SMS Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successSmsCode"></code>
                                                <small class="text-muted">Text: ATTEND [CODE] [NAME]</small>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>USSD Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successUssdCode"></code>
                                                <small class="text-muted">Dial *123*[CODE]#</small>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Public Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successPublicCode"></code>
                                                <small class="text-muted">For QR code & web link</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6><i class="fas fa-share-alt me-2"></i> Share Meeting</h6>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-outline-primary" onclick="shareSuccessViaEmail()">
                                    <i class="fas fa-envelope me-1"></i> Email
                                </button>
                                <button class="btn btn-outline-info" onclick="shareSuccessViaWhatsApp()">
                                    <i class="fab fa-whatsapp me-1"></i> WhatsApp
                                </button>
                                <button class="btn btn-outline-secondary" onclick="shareSuccessViaSMS()">
                                    <i class="fas fa-sms me-1"></i> SMS
                                </button>
                                <button class="btn btn-outline-success" onclick="copyAllCodes()">
                                    <i class="fas fa-copy me-1"></i> Copy All Codes
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-primary-custom me-2" onclick="viewMeetingDashboard()">
                            <i class="fas fa-tachometer-alt me-1"></i> Go to Dashboard
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meeting Details Modal -->
    <div class="modal fade" id="meetingDetailsModal" tabindex="-1">
        <!-- Keep existing meeting details modal -->
        <!-- ... (Keep existing meeting details modal) ... -->
    </div>
    
    <!-- Create Admin Modal -->
    <div class="modal fade" id="createAdminModal" tabindex="-1">
        <!-- Keep existing create admin modal -->
        <!-- ... (Keep existing create admin modal) ... -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- AOS Animation Library -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true
        });
        
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentOrganization = null;
        let attendanceChart = null;
        let currentMeetingFormFields = [];
        let generatedMeetingLink = '';
        let generatedQRCode = '';
        let currentMeetingCode = '';
        let currentMeetingData = null;
        
        // API Base URL - Pointing to your backend
        const API_BASE_URL = 'https://gsb-hrs3.onrender.com/api';
        const FRONTEND_URL = 'https://gsf-inky.vercel.app';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading spinner
            setTimeout(() => {
                document.getElementById('loadingSpinner').style.display = 'none';
            }, 1000);
            
            // Check if user is already logged in
            checkAuthStatus();
            
            // Setup form submissions
            setupForms();
            
            // Setup navbar scroll effect
            setupNavbarScroll();
            
            // Setup sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // Initialize form builder
            initializeFormBuilder();
            
            // Setup advanced settings interactions
            setupAdvancedSettings();
            
            // Close sidebar when clicking overlay
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const toggleBtn = document.getElementById('toggleSidebar');
                
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target) && 
                        sidebar.classList.contains('active')) {
                        closeSidebar();
                    }
                }
            });
        });
        
        // Setup advanced settings interactions
        function setupAdvancedSettings() {
            // Time verification toggles
            document.getElementById('requireMinimumStay').addEventListener('change', function() {
                document.getElementById('minimumStayMinutes').disabled = !this.checked;
            });
            
            document.getElementById('enableContinuousMonitoring').addEventListener('change', function() {
                document.getElementById('monitoringInterval').disabled = !this.checked;
            });
        }
        
        // Check authentication status
        function checkAuthStatus() {
            const token = localStorage.getItem('gsams_token');
            const user = localStorage.getItem('gsams_user');
            
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showPage('dashboard');
                loadDashboardData();
            } else {
                showPage('home');
            }
        }
        
        // Setup form submissions
        function setupForms() {
            // Register form
            document.getElementById('registerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                registerUser();
            });
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                loginUser();
            });
            
            // Create admin form
            if (document.getElementById('createAdminForm')) {
                document.getElementById('createAdminForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    createAdmin();
                });
            }
            
            // Settings form
            if (document.getElementById('settingsForm')) {
                document.getElementById('settingsForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveSettings();
                });
            }
        }
        
        // Setup navbar scroll effect
        function setupNavbarScroll() {
            window.addEventListener('scroll', function() {
                const navbar = document.querySelector('.navbar');
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        }
        
        // Show/hide pages
        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            
            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
                window.scrollTo(0, 0);
            } else if (page === 'register') {
                document.getElementById('registerPage').style.display = 'flex';
            } else if (page === 'login') {
                document.getElementById('loginPage').style.display = 'flex';
            } else if (page === 'dashboard') {
                document.getElementById('dashboard').style.display = 'block';
                loadDashboardData();
            }
        }
        
        // Show/hide dashboard sections
        function showDashboardSection(section) {
            // Close sidebar on mobile
            closeSidebar();
            
            // Hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Update active menu item
            const menuItems = document.querySelectorAll('.sidebar-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Mark clicked item as active
            event.target.classList.add('active');
            
            // Show selected section
            document.getElementById(section).style.display = 'block';
            
            // Update page title
            const titles = {
                'dashboard-home': 'Dashboard',
                'meetings': 'Meetings',
                'attendance': 'Attendance',
                'reports': 'Reports',
                'admins': 'Admins',
                'settings': 'Settings',
                'audit-logs': 'Audit Logs'
            };
            
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
            
            // Load section data
            if (section === 'meetings') {
                loadMeetings();
            } else if (section === 'attendance') {
                loadAttendance();
            } else if (section === 'admins') {
                loadAdmins();
            } else if (section === 'audit-logs') {
                loadAuditLogs();
            } else if (section === 'settings') {
                loadSettings();
            }
        }
        
        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        
        // Close sidebar on mobile
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Initialize form builder
        function initializeFormBuilder() {
            currentMeetingFormFields = [];
            updateFormPreview();
        }
        
        // Add form field
        function addFormField(type = 'text', label = '', placeholder = '', required = false, options = []) {
            const fieldId = 'field_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const field = {
                id: fieldId,
                type: type || 'text',
                label: label || 'New Field',
                placeholder: placeholder || 'Enter value',
                required: required || false,
                options: options || []
            };
            
            currentMeetingFormFields.push(field);
            renderFormField(field);
            updateFormPreview();
        }
        
        // Add default fields
        function addDefaultFields() {
            // Clear existing fields
            currentMeetingFormFields = [];
            document.getElementById('formFieldsList').innerHTML = '';
            
            // Add default fields
            addFormField('text', 'Full Name', 'Enter your full name', true);
            addFormField('email', 'Email Address', 'Enter your email address', false);
            addFormField('tel', 'Phone Number', 'Enter your phone number', true);
            addFormField('text', 'Employee/Student ID', 'Enter your ID number', false);
            addFormField('select', 'Department', 'Select your department', false, ['IT', 'HR', 'Finance', 'Operations', 'Marketing']);
            addFormField('textarea', 'Comments', 'Any additional comments', false);
            
            showToast('Default fields added successfully', 'success');
        }
        
        // Render form field in builder
        function renderFormField(field) {
            const fieldsList = document.getElementById('formFieldsList');
            
            // Remove the "no fields" message if it exists
            const alert = fieldsList.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
            
            const fieldElement = document.createElement('div');
            fieldElement.className = 'form-field-item';
            fieldElement.id = 'fieldItem_' + field.id;
            
            let optionsHTML = '';
            if (field.type === 'select' || field.type === 'radio' || field.type === 'checkbox') {
                optionsHTML = `
                    <div class="mt-2">
                        <small class="text-muted">Options (one per line):</small>
                        <textarea class="form-control form-control-sm" rows="2" onchange="updateFieldOptions('${field.id}', this.value)">${field.options.join('\n')}</textarea>
                    </div>
                `;
            }
            
            fieldElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${field.label} <span class="badge bg-secondary">${field.type}</span></h6>
                        <small class="text-muted">${field.placeholder}</small>
                        ${field.required ? '<span class="badge bg-danger ms-2">Required</span>' : ''}
                    </div>
                    <div class="field-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editField('${field.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField('${field.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${optionsHTML}
            `;
            
            fieldsList.appendChild(fieldElement);
        }
        
        // Update field options
        function updateFieldOptions(fieldId, optionsText) {
            const field = currentMeetingFormFields.find(f => f.id === fieldId);
            if (field) {
                field.options = optionsText.split('\n').filter(opt => opt.trim() !== '');
                updateFormPreview();
            }
        }
        
        // Edit field
        function editField(fieldId) {
            const field = currentMeetingFormFields.find(f => f.id === fieldId);
            if (!field) return;
            
            const newLabel = prompt('Enter field label:', field.label);
            if (newLabel === null) return;
            
            const newPlaceholder = prompt('Enter field placeholder:', field.placeholder);
            if (newPlaceholder === null) return;
            
            const isRequired = confirm('Is this field required?');
            
            field.label = newLabel;
            field.placeholder = newPlaceholder;
            field.required = isRequired;
            
            // Update the field element
            const fieldElement = document.getElementById('fieldItem_' + fieldId);
            if (fieldElement) {
                fieldElement.querySelector('h6').innerHTML = `${field.label} <span class="badge bg-secondary">${field.type}</span>`;
                fieldElement.querySelector('small').textContent = field.placeholder;
                
                const requiredBadge = fieldElement.querySelector('.badge.bg-danger');
                if (field.required && !requiredBadge) {
                    fieldElement.querySelector('h6').innerHTML += ' <span class="badge bg-danger">Required</span>';
                } else if (!field.required && requiredBadge) {
                    requiredBadge.remove();
                }
            }
            
            updateFormPreview();
            showToast('Field updated successfully', 'success');
        }
        
        // Remove field
        function removeField(fieldId) {
            if (!confirm('Are you sure you want to remove this field?')) return;
            
            currentMeetingFormFields = currentMeetingFormFields.filter(f => f.id !== fieldId);
            const fieldElement = document.getElementById('fieldItem_' + fieldId);
            if (fieldElement) {
                fieldElement.remove();
            }
            
            // Show "no fields" message if list is empty
            if (currentMeetingFormFields.length === 0) {
                const fieldsList = document.getElementById('formFieldsList');
                fieldsList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No fields added yet. Click "Add Field" to create your first form field.</div>';
            }
            
            updateFormPreview();
            showToast('Field removed successfully', 'success');
        }
        
        // Update form preview
        function updateFormPreview() {
            const preview = document.getElementById('formPreview');
            
            if (currentMeetingFormFields.length === 0) {
                preview.innerHTML = '<p class="text-muted small">No fields added yet</p>';
                return;
            }
            
            let previewHTML = '<form id="previewForm">';
            
            currentMeetingFormFields.forEach((field, index) => {
                let fieldHTML = '';
                
                switch(field.type) {
                    case 'text':
                    case 'email':
                    case 'tel':
                    case 'number':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <input type="${field.type}" class="form-control" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>
                            </div>
                        `;
                        break;
                        
                    case 'textarea':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <textarea class="form-control" rows="3" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}></textarea>
                            </div>
                        `;
                        break;
                        
                    case 'select':
                        let optionsHTML = '<option value="">Select...</option>';
                        field.options.forEach(option => {
                            optionsHTML += `<option value="${option}">${option}</option>`;
                        });
                        
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <select class="form-select" ${field.required ? 'required' : ''}>
                                    ${optionsHTML}
                                </select>
                            </div>
                        `;
                        break;
                        
                    case 'radio':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                ${field.options.map(option => `
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="${field.id}" id="${field.id}_${option}" value="${option}">
                                        <label class="form-check-label" for="${field.id}_${option}">${option}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;
                        
                    case 'checkbox':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                ${field.options.map(option => `
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="${field.id}_${option}" value="${option}">
                                        <label class="form-check-label" for="${field.id}_${option}">${option}</label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;
                }
                
                previewHTML += fieldHTML;
            });
            
            previewHTML += '<button type="submit" class="btn btn-primary-custom w-100">Submit Attendance</button></form>';
            preview.innerHTML = previewHTML;
        }
        
        // Tab navigation for create meeting modal
        function nextTab() {
            const currentTab = document.querySelector('#meetingTabs .nav-link.active');
            const tabs = Array.from(document.querySelectorAll('#meetingTabs .nav-link'));
            const currentIndex = tabs.indexOf(currentTab);
            
            if (currentIndex < tabs.length - 1) {
                const nextTab = tabs[currentIndex + 1];
                const nextTabPane = document.querySelector(nextTab.getAttribute('data-bs-target'));
                
                // Validate current tab before proceeding
                if (currentIndex === 0) { // Details tab
                    if (!validateMeetingDetails()) {
                        showToast('Please fill in all required meeting details', 'error');
                        return;
                    }
                } else if (currentIndex === 1) { // Form builder tab
                    const requireForm = document.getElementById('requireForm')?.checked || false;
                    if (requireForm && currentMeetingFormFields.length === 0) {
                        showToast('Form is required but no fields added. Please add at least one field.', 'error');
                        return;
                    }
                }
                
                // Show next tab
                currentTab.classList.remove('active');
                currentTab.setAttribute('aria-selected', 'false');
                
                nextTab.classList.add('active');
                nextTab.setAttribute('aria-selected', 'true');
                
                // Show next tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                nextTabPane.classList.add('show', 'active');
                
                // Update button visibility
                updateTabButtons();
            }
        }
        
        function prevTab() {
            const currentTab = document.querySelector('#meetingTabs .nav-link.active');
            const tabs = Array.from(document.querySelectorAll('#meetingTabs .nav-link'));
            const currentIndex = tabs.indexOf(currentTab);
            
            if (currentIndex > 0) {
                const prevTab = tabs[currentIndex - 1];
                const prevTabPane = document.querySelector(prevTab.getAttribute('data-bs-target'));
                
                // Show previous tab
                currentTab.classList.remove('active');
                currentTab.setAttribute('aria-selected', 'false');
                
                prevTab.classList.add('active');
                prevTab.setAttribute('aria-selected', 'true');
                
                // Show previous tab content
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                prevTabPane.classList.add('show', 'active');
                
                // Update button visibility
                updateTabButtons();
            }
        }
        
        function updateTabButtons() {
            const currentTab = document.querySelector('#meetingTabs .nav-link.active');
            const tabs = Array.from(document.querySelectorAll('#meetingTabs .nav-link'));
            const currentIndex = tabs.indexOf(currentTab);
            
            document.getElementById('prevTabBtn').style.display = currentIndex > 0 ? 'inline-block' : 'none';
            document.getElementById('nextTabBtn').style.display = currentIndex < tabs.length - 1 ? 'inline-block' : 'none';
        }
        
        // Validate meeting details
        function validateMeetingDetails() {
            const title = document.getElementById('meetingTitle').value.trim();
            const locationName = document.getElementById('meetingLocationName').value.trim();
            const startTime = document.getElementById('meetingStartTime').value;
            const endTime = document.getElementById('meetingEndTime').value;
            const latitude = document.getElementById('meetingLatitude').value;
            const longitude = document.getElementById('meetingLongitude').value;
            const radius = document.getElementById('meetingRadius').value;
            
            if (!title) {
                showToast('Meeting title is required', 'error');
                document.getElementById('meetingTitle').focus();
                return false;
            }
            
            if (!locationName) {
                showToast('Location name is required', 'error');
                document.getElementById('meetingLocationName').focus();
                return false;
            }
            
            if (!startTime) {
                showToast('Start time is required', 'error');
                document.getElementById('meetingStartTime').focus();
                return false;
            }
            
            if (!endTime) {
                showToast('End time is required', 'error');
                document.getElementById('meetingEndTime').focus();
                return false;
            }
            
            // Check if end time is after start time
            if (new Date(startTime) >= new Date(endTime)) {
                showToast('End time must be after start time', 'error');
                document.getElementById('meetingEndTime').focus();
                return false;
            }
            
            if (!latitude || !longitude) {
                showToast('Location coordinates are required', 'error');
                return false;
            }
            
            if (!radius || radius < 10 || radius > 1000) {
                showToast('Radius must be between 10 and 1000 meters', 'error');
                document.getElementById('meetingRadius').focus();
                return false;
            }
            
            return true;
        }
        
        // Validate complete meeting creation form
        function validateMeetingCreation() {
            // Validate basic meeting details
            if (!validateMeetingDetails()) {
                return false;
            }
            
            // Validate at least one attendance method is selected
            const gps = document.getElementById('allowGPSMeeting').checked;
            const sms = document.getElementById('allowSMSMeeting').checked;
            const ussd = document.getElementById('allowUSSDMeeting').checked;
            const kiosk = document.getElementById('allowKioskMeeting').checked;
            const manual = document.getElementById('allowManualMeeting').checked;
            
            if (!gps && !sms && !ussd && !kiosk && !manual) {
                showToast('Please select at least one attendance method', 'error');
                document.querySelector('#advanced-tab').click();
                return false;
            }
            
            return true;
        }
        
        // Register user
        async function registerUser() {
            const organizationName = document.getElementById('regOrganizationName').value;
            const fullName = document.getElementById('regFullName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        fullName,
                        phone,
                        organizationName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    authToken = data.token;
                    currentUser = data.user;
                    
                    localStorage.setItem('gsams_token', authToken);
                    localStorage.setItem('gsams_user', JSON.stringify(currentUser));
                    
                    showToast('Registration successful!', 'success');
                    showPage('dashboard');
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Registration failed. Please try again.', 'error');
            }
        }
        
        // Login user
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    authToken = data.token;
                    currentUser = data.user;
                    
                    localStorage.setItem('gsams_token', authToken);
                    localStorage.setItem('gsams_user', JSON.stringify(currentUser));
                    
                    showToast('Login successful!', 'success');
                    showPage('dashboard');
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please try again.', 'error');
            }
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('gsams_token');
            localStorage.removeItem('gsams_user');
            authToken = null;
            currentUser = null;
            showToast('Logged out successfully', 'success');
            showPage('home');
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            if (!authToken) return;
            
            try {
                // Load dashboard stats
                const response = await fetch(`${API_BASE_URL}/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update stats
                    document.getElementById('totalMeetings').textContent = data.summary.totalMeetings || 0;
                    document.getElementById('activeMeetings').textContent = data.summary.activeMeetings || 0;
                    document.getElementById('totalAttendance').textContent = data.summary.totalAttendance || 0;
                    document.getElementById('todayAttendance').textContent = data.summary.todayAttendance || 0;
                    
                    // Update user info
                    document.getElementById('userName').textContent = currentUser.fullName;
                    document.getElementById('userRole').textContent = currentUser.role === 'super_admin' ? 'Super Admin' : 
                                                                     currentUser.role === 'admin' ? 'Admin' : 'Viewer';
                    document.getElementById('userAvatar').textContent = getInitials(currentUser.fullName);
                    
                    // Update recent attendance
                    updateRecentAttendance(data.recentAttendance);
                    
                    // Update attendance chart
                    updateAttendanceChart(data.byType);
                    
                    // Load upcoming meetings
                    loadUpcomingMeetings();
                    
                    // Load organization info
                    loadOrganizationInfo();
                }
            } catch (error) {
                console.error('Dashboard data error:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }
        
        // Load organization info
        async function loadOrganizationInfo() {
            try {
                const response = await fetch(`${API_BASE_URL}/organization`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const org = await response.json();
                    currentOrganization = org;
                    
                    if (document.getElementById('orgName')) {
                        document.getElementById('orgName').textContent = org.name;
                        document.getElementById('orgDomain').textContent = org.domain;
                        document.getElementById('orgCreated').textContent = new Date(org.createdAt).toLocaleDateString();
                        document.getElementById('orgStatus').textContent = org.isActive ? 'Active' : 'Inactive';
                    }
                }
            } catch (error) {
                console.error('Organization info error:', error);
            }
        }
        
        // Load meetings
        async function loadMeetings() {
            try {
                const status = document.getElementById('meetingStatusFilter')?.value || '';
                const startDate = document.getElementById('meetingStartDate')?.value || '';
                const endDate = document.getElementById('meetingEndDate')?.value || '';
                
                let url = `${API_BASE_URL}/meetings`;
                const params = new URLSearchParams();
                
                if (status) params.append('status', status);
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meetings = await response.json();
                    updateMeetingsTable(meetings);
                } else {
                    throw new Error('Failed to load meetings');
                }
            } catch (error) {
                console.error('Load meetings error:', error);
                showToast('Failed to load meetings', 'error');
                updateMeetingsTable([]);
            }
        }
        
        // Load upcoming meetings for dashboard
        async function loadUpcomingMeetings() {
            try {
                const now = new Date();
                const future = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days from now
                
                const response = await fetch(`${API_BASE_URL}/meetings?startDate=${now.toISOString()}&endDate=${future.toISOString()}&status=active`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meetings = await response.json();
                    updateUpcomingMeetingsTable(meetings);
                }
            } catch (error) {
                console.error('Load upcoming meetings error:', error);
            }
        }
        
        // Load attendance records
        async function loadAttendance() {
            try {
                const meetingId = document.getElementById('attendanceMeetingFilter')?.value || '';
                const type = document.getElementById('attendanceTypeFilter')?.value || '';
                const status = document.getElementById('attendanceStatusFilter')?.value || '';
                
                // First, load meetings for the filter dropdown
                const meetingsResponse = await fetch(`${API_BASE_URL}/meetings`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (meetingsResponse.ok) {
                    const meetings = await meetingsResponse.json();
                    updateMeetingFilter(meetings);
                    
                    // If a specific meeting is selected, load its attendance
                    if (meetingId) {
                        let attendanceUrl = `${API_BASE_URL}/meetings/${meetingId}/attendance`;
                        const params = new URLSearchParams();
                        
                        if (type) params.append('verificationType', type);
                        if (status) params.append('status', status);
                        
                        if (params.toString()) {
                            attendanceUrl += `?${params.toString()}`;
                        }
                        
                        const attendanceResponse = await fetch(attendanceUrl, {
                            headers: {
                                'Authorization': `Bearer ${authToken}`
                            }
                        });
                        
                        if (attendanceResponse.ok) {
                            const data = await attendanceResponse.json();
                            updateAttendanceTable(data.attendance || []);
                        }
                    } else {
                        // For now, show empty table or message
                        updateAttendanceTable([]);
                    }
                }
            } catch (error) {
                console.error('Load attendance error:', error);
                showToast('Failed to load attendance', 'error');
            }
        }
        
        // Load admins
        async function loadAdmins() {
            try {
                const response = await fetch(`${API_BASE_URL}/admins`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const admins = await response.json();
                    updateAdminsTable(admins);
                }
            } catch (error) {
                console.error('Load admins error:', error);
                showToast('Failed to load admins', 'error');
            }
        }
        
        // Load audit logs
        async function loadAuditLogs() {
            try {
                const startDate = document.getElementById('auditStartDate')?.value || '';
                const endDate = document.getElementById('auditEndDate')?.value || '';
                const action = document.getElementById('auditActionFilter')?.value || '';
                
                let url = `${API_BASE_URL}/audit-logs`;
                const params = new URLSearchParams();
                
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (action) params.append('action', action);
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateAuditLogsTable(data.logs || []);
                }
            } catch (error) {
                console.error('Load audit logs error:', error);
                showToast('Failed to load audit logs', 'error');
            }
        }
        
        // Load settings
        function loadSettings() {
            if (!currentOrganization) return;
            
            if (document.getElementById('defaultRadius')) {
                document.getElementById('defaultRadius').value = currentOrganization.settings?.defaultLocationRadius || 100;
                document.getElementById('defaultTimeWindow').value = currentOrganization.settings?.defaultTimeWindow || 30;
                document.getElementById('allowGPS').checked = currentOrganization.settings?.allowGPS !== false;
                document.getElementById('allowSMS').checked = currentOrganization.settings?.allowSMS !== false;
                document.getElementById('allowUSSD').checked = currentOrganization.settings?.allowUSSD !== false;
                document.getElementById('allowKiosk').checked = currentOrganization.settings?.allowKiosk !== false;
                document.getElementById('allowManual').checked = currentOrganization.settings?.allowManual !== false;
            }
        }
        
        // Create meeting
        async function createMeeting() {
            try {
                // Validate complete meeting creation form
                if (!validateMeetingCreation()) {
                    return;
                }
                
                // Show loading state
                const createBtn = document.getElementById('createMeetingBtn');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Creating...';
                createBtn.disabled = true;
                
                // Gather meeting data
                const meetingData = {
                    title: document.getElementById('meetingTitle').value.trim(),
                    description: document.getElementById('meetingDescription').value.trim() || '',
                    location: {
                        name: document.getElementById('meetingLocationName').value.trim(),
                        latitude: parseFloat(document.getElementById('meetingLatitude').value),
                        longitude: parseFloat(document.getElementById('meetingLongitude').value),
                        radius: parseInt(document.getElementById('meetingRadius').value),
                        address: document.getElementById('meetingAddress')?.value.trim() || ''
                    },
                    schedule: {
                        startTime: document.getElementById('meetingStartTime').value,
                        endTime: document.getElementById('meetingEndTime').value,
                        bufferBefore: 30,
                        bufferAfter: 30
                    },
                    attendanceConfig: {
                        allowedModes: {
                            smartphoneGPS: document.getElementById('allowGPSMeeting').checked,
                            sms: document.getElementById('allowSMSMeeting').checked,
                            ussd: document.getElementById('allowUSSDMeeting').checked,
                            kiosk: document.getElementById('allowKioskMeeting').checked,
                            manual: document.getElementById('allowManualMeeting').checked
                        },
                        requiredFields: currentMeetingFormFields.filter(f => f.required).map(f => ({
                            field: f.label.toLowerCase().replace(/\s+/g, '_'),
                            isRequired: true
                        })),
                        verificationStrictness: document.getElementById('verificationStrictness').value,
                        duplicatePrevention: {
                            preventSameDevice: document.getElementById('preventSameDevice').checked,
                            preventSamePhone: document.getElementById('preventSamePhone').checked,
                            preventSameNameTime: document.getElementById('preventSameNameTime').checked,
                            timeWindowMinutes: parseInt(document.getElementById('duplicateTimeWindow').value) || 5
                        }
                    },
                    customFormFields: currentMeetingFormFields.map(field => ({
                        fieldName: field.label.toLowerCase().replace(/\s+/g, '_'),
                        fieldType: field.type,
                        label: field.label,
                        placeholder: field.placeholder,
                        options: field.options.map(opt => ({ value: opt, label: opt })),
                        isRequired: field.required,
                        order: currentMeetingFormFields.indexOf(field)
                    })),
                    timeVerification: {
                        requireMinimumStay: document.getElementById('requireMinimumStay').checked,
                        minimumStayMinutes: parseInt(document.getElementById('minimumStayMinutes').value) || 5,
                        enableContinuousMonitoring: document.getElementById('enableContinuousMonitoring').checked,
                        monitoringInterval: parseInt(document.getElementById('monitoringInterval').value) || 5,
                        maxAllowedAbsence: 2,
                        autoVerifyAfterStay: false,
                        autoVerifyMinutes: 10
                    },
                    pwaSettings: {
                        enablePWA: document.getElementById('enablePWA').checked,
                        appName: document.getElementById('appName').value,
                        themeColor: document.getElementById('themeColor').value,
                        backgroundColor: document.getElementById('backgroundColor').value
                    }
                };
                
                const response = await fetch(`${API_BASE_URL}/meetings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(meetingData)
                });
                
                if (response.ok) {
                    const meeting = await response.json();
                    
                    // Store meeting data for success modal
                    currentMeetingData = meeting;
                    
                    // Show success modal
                    showMeetingSuccessModal(meeting);
                    
                    // Close create meeting modal
                    const createModal = bootstrap.Modal.getInstance(document.getElementById('createMeetingModal'));
                    createModal.hide();
                    
                    // Reset form
                    resetMeetingForm();
                    
                    // Reload meetings list
                    loadMeetings();
                    loadUpcomingMeetings();
                    loadDashboardData();
                    
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create meeting', 'error');
                }
            } catch (error) {
                console.error('Create meeting error:', error);
                showToast('Failed to create meeting. Please try again.', 'error');
            } finally {
                // Reset button state
                const createBtn = document.getElementById('createMeetingBtn');
                createBtn.innerHTML = '<i class="fas fa-calendar-plus me-2"></i> Create Meeting';
                createBtn.disabled = false;
            }
        }
        
        // Reset meeting form
        function resetMeetingForm() {
            document.getElementById('createMeetingForm').reset();
            currentMeetingFormFields = [];
            document.getElementById('formFieldsList').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No fields added yet. Click "Add Field" to create your first form field.</div>';
            updateFormPreview();
            
            // Reset sharing section
            document.getElementById('generatedLink').innerHTML = '<span class="text-muted">Link will be generated after meeting creation</span>';
            document.getElementById('qrCodeCanvas').innerHTML = '<div class="text-center"><i class="fas fa-qrcode fa-4x text-muted mb-2"></i><p class="small text-muted">QR code will be generated<br>after meeting creation</p></div>';
            document.getElementById('copyLinkBtn').disabled = true;
            document.getElementById('testLinkBtn').disabled = true;
            document.getElementById('downloadQRBtn').disabled = true;
            document.getElementById('shareEmailBtn').disabled = true;
            document.getElementById('shareWhatsAppBtn').disabled = true;
            document.getElementById('shareSMSBtn').disabled = true;
            
            // Reset advanced settings
            document.getElementById('verificationStrictness').value = 'medium';
            document.getElementById('preventSameDevice').checked = true;
            document.getElementById('preventSamePhone').checked = true;
            document.getElementById('preventSameNameTime').checked = true;
            document.getElementById('duplicateTimeWindow').value = '5';
            document.getElementById('requireMinimumStay').checked = false;
            document.getElementById('minimumStayMinutes').disabled = true;
            document.getElementById('minimumStayMinutes').value = '5';
            document.getElementById('enableContinuousMonitoring').checked = false;
            document.getElementById('monitoringInterval').disabled = true;
            document.getElementById('monitoringInterval').value = '5';
            document.getElementById('enablePWA').checked = true;
            document.getElementById('appName').value = 'GSAMS Attendance';
            document.getElementById('themeColor').value = '#2196F3';
            document.getElementById('backgroundColor').value = '#ffffff';
            
            // Set default date/times
            const now = new Date();
            const future = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Tomorrow
            
            document.getElementById('meetingStartTime').value = formatDateTimeLocal(future);
            document.getElementById('meetingEndTime').value = formatDateTimeLocal(new Date(future.getTime() + 2 * 60 * 60 * 1000)); // 2 hours later
            
            // Set placeholder coordinates
            document.getElementById('meetingLatitude').value = '40.7128';
            document.getElementById('meetingLongitude').value = '-74.0060';
            
            // Reset to first tab
            document.querySelector('#meetingTabs .nav-link').click();
        }
        
        // Show meeting success modal
        function showMeetingSuccessModal(meeting) {
            // Update modal content with meeting data
            document.getElementById('successMeetingTitle').textContent = meeting.title;
            document.getElementById('successSmsCode').textContent = meeting.accessCodes?.smsCode || 'N/A';
            document.getElementById('successUssdCode').textContent = meeting.accessCodes?.ussdCode || 'N/A';
            document.getElementById('successPublicCode').textContent = meeting.accessCodes?.publicCode || 'N/A';
            
            // Generate meeting link
            const meetingLink = `${FRONTEND_URL}/attend/${meeting.accessCodes?.publicCode}`;
            generatedMeetingLink = meetingLink;
            
            // Display the link
            document.getElementById('successGeneratedLink').innerHTML = `
                <a href="${meetingLink}" target="_blank" class="text-decoration-none">${meetingLink}</a>
            `;
            
            // Generate QR code
            generateSuccessQRCode(meetingLink);
            
            // Show modal
            const successModal = new bootstrap.Modal(document.getElementById('meetingSuccessModal'));
            successModal.show();
        }
        
        // Generate QR code for success modal
        function generateSuccessQRCode(text) {
            const qrContainer = document.getElementById('successQrCodeCanvas');
            qrContainer.innerHTML = '';
            
            QRCode.toCanvas(text, { width: 200, margin: 2, color: { dark: '#4361ee', light: '#ffffff' } }, function(error, canvas) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    qrContainer.innerHTML = '<p class="text-danger">Failed to generate QR code</p>';
                    return;
                }
                
                canvas.className = 'qr-code-canvas';
                qrContainer.appendChild(canvas);
                generatedQRCode = canvas.toDataURL('image/png');
            });
        }
        
        // Copy meeting link to clipboard from success modal
        function copySuccessMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            navigator.clipboard.writeText(generatedMeetingLink).then(() => {
                showToast('Meeting link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy link', 'error');
            });
        }
        
        // Test meeting link from success modal
        function testSuccessMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            window.open(generatedMeetingLink, '_blank');
            showToast('Opening meeting link in new tab', 'info');
        }
        
        // Download QR code from success modal
        function downloadSuccessQRCode() {
            if (!generatedQRCode) {
                showToast('No QR code available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'meeting';
            const filename = `qr-code-${meetingTitle.replace(/\s+/g, '-').toLowerCase()}.png`;
            
            const link = document.createElement('a');
            link.href = generatedQRCode;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('QR code downloaded successfully!', 'success');
        }
        
        // Share via Email from success modal
        function shareSuccessViaEmail() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const subject = `Join ${meetingTitle}`;
            const body = `You're invited to join ${meetingTitle}.\n\nJoin via: ${generatedMeetingLink}\n\nSMS Code: ${currentMeetingData?.accessCodes?.smsCode}\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}\n\nOr scan the attached QR code to join.`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }
        
        // Share via WhatsApp from success modal
        function shareSuccessViaWhatsApp() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const text = `Join ${meetingTitle}:\n${generatedMeetingLink}\n\nSMS Code: ${currentMeetingData?.accessCodes?.smsCode}\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}`;
            
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappLink, '_blank');
        }
        
        // Share via SMS from success modal
        function shareSuccessViaSMS() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const body = `Join ${meetingTitle}:\n${generatedMeetingLink}\n\nSMS: ATTEND ${currentMeetingData?.accessCodes?.smsCode} [YOUR NAME]\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}`;
            
            const smsLink = `sms:?body=${encodeURIComponent(body)}`;
            window.location.href = smsLink;
        }
        
        // Copy all codes from success modal
        function copyAllCodes() {
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const link = generatedMeetingLink || '';
            const smsCode = currentMeetingData?.accessCodes?.smsCode || 'N/A';
            const ussdCode = currentMeetingData?.accessCodes?.ussdCode || 'N/A';
            const publicCode = currentMeetingData?.accessCodes?.publicCode || 'N/A';
            
            const text = `${meetingTitle}\n\nMeeting Link: ${link}\nSMS Code: ${smsCode}\nUSSD Code: ${ussdCode}\nPublic Code: ${publicCode}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('All codes copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy codes', 'error');
            });
        }
        
        // View meeting dashboard
        function viewMeetingDashboard() {
            // Close success modal
            const successModal = bootstrap.Modal.getInstance(document.getElementById('meetingSuccessModal'));
            successModal.hide();
            
            // Navigate to meetings section
            showDashboardSection('meetings');
        }
        
        // Original sharing functions (for create meeting modal)
        function copyMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            navigator.clipboard.writeText(generatedMeetingLink).then(() => {
                showToast('Meeting link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy link', 'error');
            });
        }
        
        function testMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            window.open(generatedMeetingLink, '_blank');
            showToast('Opening meeting link in new tab', 'info');
        }
        
        function downloadQRCode() {
            if (!generatedQRCode) {
                showToast('No QR code available', 'error');
                return;
            }
            
            const meetingTitle = document.getElementById('meetingTitle').value || 'meeting';
            const filename = `qr-code-${meetingTitle.replace(/\s+/g, '-').toLowerCase()}.png`;
            
            const link = document.createElement('a');
            link.href = generatedQRCode;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('QR code downloaded successfully!', 'success');
        }
        
        function shareViaEmail() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = document.getElementById('meetingTitle').value || 'Meeting';
            const subject = `Join ${meetingTitle}`;
            const body = `You're invited to join ${meetingTitle}. Click the link below to join:\n\n${generatedMeetingLink}\n\nOr scan the attached QR code to join.`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }
        
        function shareViaWhatsApp() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = document.getElementById('meetingTitle').value || 'Meeting';
            const text = `Join ${meetingTitle}: ${generatedMeetingLink}`;
            
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappLink, '_blank');
        }
        
        function shareViaSMS() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = document.getElementById('meetingTitle').value || 'Meeting';
            const body = `Join ${meetingTitle}: ${generatedMeetingLink}`;
            
            const smsLink = `sms:?body=${encodeURIComponent(body)}`;
            window.location.href = smsLink;
        }
        
        // Show create meeting modal
        function showCreateMeetingModal() {
            // Reset form
            resetMeetingForm();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createMeetingModal'));
            modal.show();
        }
        
        // Show create admin modal
        function showCreateAdminModal() {
            const modal = new bootstrap.Modal(document.getElementById('createAdminModal'));
            modal.show();
        }
        
        // Show meeting details modal
        function showMeetingDetailsModal(meetingId) {
            // Fetch meeting details
            fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            })
            .then(response => response.json())
            .then(meeting => {
                // Update modal content
                const modal = new bootstrap.Modal(document.getElementById('meetingDetailsModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Meeting details error:', error);
                showToast('Failed to load meeting details', 'error');
            });
        }
        
        // Delete meeting
        async function deleteMeeting(meetingId) {
            if (!confirm('Are you sure you want to delete this meeting? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showToast('Meeting deleted successfully!', 'success');
                    // Reload meetings
                    loadMeetings();
                    loadUpcomingMeetings();
                    // Update dashboard stats
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to delete meeting', 'error');
                }
            } catch (error) {
                console.error('Delete meeting error:', error);
                showToast('Failed to delete meeting', 'error');
            }
        }
        
        // Create admin
        async function createAdmin() {
            try {
                const adminData = {
                    email: document.getElementById('adminEmail').value,
                    password: document.getElementById('adminPassword').value,
                    fullName: document.getElementById('adminFullName').value,
                    phone: document.getElementById('adminPhone').value,
                    role: document.getElementById('adminRole').value
                };
                
                const response = await fetch(`${API_BASE_URL}/admins`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(adminData)
                });
                
                if (response.ok) {
                    const admin = await response.json();
                    showToast('Admin created successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('createAdminModal'));
                    modal.hide();
                    
                    // Reset form
                    document.getElementById('createAdminForm').reset();
                    
                    // Reload admins
                    loadAdmins();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create admin', 'error');
                }
            } catch (error) {
                console.error('Create admin error:', error);
                showToast('Failed to create admin', 'error');
            }
        }
        
        // Save settings
        async function saveSettings() {
            try {
                const settings = {
                    defaultLocationRadius: parseInt(document.getElementById('defaultRadius').value),
                    defaultTimeWindow: parseInt(document.getElementById('defaultTimeWindow').value),
                    allowGPS: document.getElementById('allowGPS').checked,
                    allowSMS: document.getElementById('allowSMS').checked,
                    allowUSSD: document.getElementById('allowUSSD').checked,
                    allowKiosk: document.getElementById('allowKiosk').checked,
                    allowManual: document.getElementById('allowManual').checked
                };
                
                const response = await fetch(`${API_BASE_URL}/organization/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ settings })
                });
                
                if (response.ok) {
                    const org = await response.json();
                    currentOrganization = org;
                    showToast('Settings saved successfully!', 'success');
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to save settings', 'error');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showToast('Failed to save settings', 'error');
            }
        }
        
        // Export report
        function exportReport(format) {
            const meetingId = document.getElementById('attendanceMeetingFilter')?.value || '';
            
            if (!meetingId) {
                showToast('Please select a meeting first', 'warning');
                return;
            }
            
            let url;
            if (format === 'pdf') {
                url = `${API_BASE_URL}/meetings/${meetingId}/export/pdf`;
            } else if (format === 'excel') {
                url = `${API_BASE_URL}/meetings/${meetingId}/export/excel`;
            }
            
            // Create a temporary link to trigger download
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', '');
            link.setAttribute('target', '_blank');
            
            // Add authorization header
            const headers = new Headers();
            headers.append('Authorization', `Bearer ${authToken}`);
            
            // Fetch with credentials
            fetch(url, { headers })
                .then(response => response.blob())
                .then(blob => {
                    const downloadUrl = window.URL.createObjectURL(blob);
                    link.href = downloadUrl;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);
                    
                    showToast(`${format.toUpperCase()} report downloaded`, 'success');
                })
                .catch(error => {
                    console.error('Export error:', error);
                    showToast(`Failed to export ${format} report`, 'error');
                });
        }
        
        // Regenerate API key
        function regenerateApiKey() {
            showToast('API key regeneration would be implemented in a full version', 'info');
        }
        
        // Update meetings table
        function updateMeetingsTable(meetings) {
            const tbody = document.getElementById('meetingsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!meetings || meetings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No meetings found</p>
                            <button class="btn btn-sm btn-primary-custom" onclick="showCreateMeetingModal()">
                                Create Your First Meeting
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            meetings.forEach(meeting => {
                const row = document.createElement('tr');
                
                // Format date
                const startTime = new Date(meeting.schedule.startTime);
                const dateStr = startTime.toLocaleDateString() + ' ' + startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Get attendance methods
                const methods = [];
                if (meeting.attendanceConfig?.allowedModes?.smartphoneGPS) methods.push('GPS');
                if (meeting.attendanceConfig?.allowedModes?.sms) methods.push('SMS');
                if (meeting.attendanceConfig?.allowedModes?.ussd) methods.push('USSD');
                if (meeting.attendanceConfig?.allowedModes?.kiosk) methods.push('Kiosk');
                if (meeting.attendanceConfig?.allowedModes?.manual) methods.push('Manual');
                
                // Status badge
                let statusBadge;
                switch(meeting.status) {
                    case 'draft': statusBadge = '<span class="badge bg-secondary">Draft</span>'; break;
                    case 'active': statusBadge = '<span class="badge bg-success">Active</span>'; break;
                    case 'in_progress': statusBadge = '<span class="badge bg-primary">In Progress</span>'; break;
                    case 'completed': statusBadge = '<span class="badge bg-info">Completed</span>'; break;
                    case 'cancelled': statusBadge = '<span class="badge bg-danger">Cancelled</span>'; break;
                    default: statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                row.innerHTML = `
                    <td>${meeting.title}</td>
                    <td>${dateStr}</td>
                    <td>${meeting.location?.name || 'N/A'}</td>
                    <td>${methods.join(', ') || 'None'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="showMeetingDetailsModal('${meeting._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="startMeeting('${meeting._id}')">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteMeeting('${meeting._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update upcoming meetings table
        function updateUpcomingMeetingsTable(meetings) {
            const tbody = document.getElementById('upcomingMeetings');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!meetings || meetings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <i class="fas fa-calendar-plus fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No upcoming meetings</p>
                            <button class="btn btn-sm btn-primary-custom" onclick="showCreateMeetingModal()">
                                Create Your First Meeting
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show only first 5 meetings
            const displayMeetings = meetings.slice(0, 5);
            
            displayMeetings.forEach(meeting => {
                const row = document.createElement('tr');
                
                // Format date
                const startTime = new Date(meeting.schedule.startTime);
                const dateStr = startTime.toLocaleDateString() + ' ' + startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Status badge
                let statusBadge;
                switch(meeting.status) {
                    case 'draft': statusBadge = '<span class="badge bg-secondary">Draft</span>'; break;
                    case 'active': statusBadge = '<span class="badge bg-success">Active</span>'; break;
                    case 'in_progress': statusBadge = '<span class="badge bg-primary">In Progress</span>'; break;
                    default: statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                row.innerHTML = `
                    <td>${meeting.title}</td>
                    <td>${dateStr}</td>
                    <td>${meeting.location?.name || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="showMeetingDetailsModal('${meeting._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="startMeeting('${meeting._id}')">
                            <i class="fas fa-play"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update attendance table
        function updateAttendanceTable(attendance) {
            const tbody = document.getElementById('attendanceTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!attendance || attendance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <i class="fas fa-user-times fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No attendance records found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            attendance.forEach(record => {
                const row = document.createElement('tr');
                
                // Format time
                const checkInTime = new Date(record.timeTracking?.checkInTime || record.createdAt);
                const timeStr = checkInTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Verification type
                let typeBadge;
                switch(record.verificationType) {
                    case 'smartphone_gps': typeBadge = '<span class="badge bg-primary">GPS</span>'; break;
                    case 'sms': typeBadge = '<span class="badge bg-info">SMS</span>'; break;
                    case 'ussd': typeBadge = '<span class="badge bg-warning">USSD</span>'; break;
                    case 'kiosk': typeBadge = '<span class="badge bg-secondary">Kiosk</span>'; break;
                    case 'manual': typeBadge = '<span class="badge bg-success">Manual</span>'; break;
                    default: typeBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                // Confidence indicator
                const confidenceScore = record.verificationDetails?.confidenceScore || 0;
                let confidenceClass = 'bg-danger';
                if (confidenceScore >= 70) confidenceClass = 'bg-success';
                else if (confidenceScore >= 40) confidenceClass = 'bg-warning';
                
                // Status badge
                let statusBadge;
                switch(record.status) {
                    case 'pending': statusBadge = '<span class="badge bg-warning">Pending</span>'; break;
                    case 'verified': statusBadge = '<span class="badge bg-success">Verified</span>'; break;
                    case 'flagged': statusBadge = '<span class="badge bg-danger">Flagged</span>'; break;
                    case 'rejected': statusBadge = '<span class="badge bg-secondary">Rejected</span>'; break;
                    default: statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                row.innerHTML = `
                    <td>${record.attendeeInfo?.fullName || 'Unknown'}</td>
                    <td>${record.meetingId?.title || 'Meeting'}</td>
                    <td>${typeBadge}</td>
                    <td>${timeStr}</td>
                    <td>${record.locationData?.isWithinRadius ? 'Within Radius' : 'Outside Radius'}</td>
                    <td>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${confidenceClass}" style="width: ${confidenceScore}%"></div>
                        </div>
                        <small>${confidenceScore}%</small>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewAttendanceDetails('${record._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="verifyAttendance('${record._id}')">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="rejectAttendance('${record._id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update admins table
        function updateAdminsTable(admins) {
            const tbody = document.getElementById('adminsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!admins || admins.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <i class="fas fa-users fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No admins found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            admins.forEach(admin => {
                const row = document.createElement('tr');
                
                // Format last login
                let lastLoginStr = 'Never';
                if (admin.lastLogin) {
                    const lastLogin = new Date(admin.lastLogin);
                    lastLoginStr = lastLogin.toLocaleDateString();
                }
                
                // Role badge
                let roleBadge;
                switch(admin.role) {
                    case 'super_admin': roleBadge = '<span class="badge bg-danger">Super Admin</span>'; break;
                    case 'admin': roleBadge = '<span class="badge bg-primary">Admin</span>'; break;
                    case 'viewer': roleBadge = '<span class="badge bg-secondary">Viewer</span>'; break;
                    default: roleBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                // Status badge
                const statusBadge = admin.isActive ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-danger">Inactive</span>';
                
                row.innerHTML = `
                    <td>${admin.fullName}</td>
                    <td>${admin.email}</td>
                    <td>${admin.phone || '-'}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${lastLoginStr}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editAdmin('${admin._id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAdmin('${admin._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update audit logs table
        function updateAuditLogsTable(logs) {
            const tbody = document.getElementById('auditLogsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!logs || logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No audit logs found</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                
                // Format timestamp
                const timestamp = new Date(log.timestamp);
                const timeStr = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                row.innerHTML = `
                    <td>${timeStr}</td>
                    <td>${log.userId?.fullName || 'System'}</td>
                    <td>${log.action?.replace(/_/g, ' ') || 'Unknown'}</td>
                    <td>${log.entityType || '-'}</td>
                    <td>${JSON.stringify(log.details || {}).substring(0, 50)}...</td>
                    <td>${log.ipAddress || '-'}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update recent attendance
        function updateRecentAttendance(attendance) {
            const tbody = document.getElementById('recentAttendance');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!attendance || attendance.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-3">
                            <p class="text-muted mb-0">No recent attendance</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            attendance.forEach(record => {
                const row = document.createElement('tr');
                
                // Format time
                const checkInTime = new Date(record.createdAt);
                const timeStr = checkInTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Verification type
                let typeBadge;
                switch(record.verificationType) {
                    case 'smartphone_gps': typeBadge = '<span class="badge bg-primary">GPS</span>'; break;
                    case 'sms': typeBadge = '<span class="badge bg-info">SMS</span>'; break;
                    case 'ussd': typeBadge = '<span class="badge bg-warning">USSD</span>'; break;
                    case 'kiosk': typeBadge = '<span class="badge bg-secondary">Kiosk</span>'; break;
                    case 'manual': typeBadge = '<span class="badge bg-success">Manual</span>'; break;
                    default: typeBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                // Status badge
                let statusBadge;
                switch(record.status) {
                    case 'pending': statusBadge = '<span class="badge bg-warning">Pending</span>'; break;
                    case 'verified': statusBadge = '<span class="badge bg-success">Verified</span>'; break;
                    case 'flagged': statusBadge = '<span class="badge bg-danger">Flagged</span>'; break;
                    case 'rejected': statusBadge = '<span class="badge bg-secondary">Rejected</span>'; break;
                    default: statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                row.innerHTML = `
                    <td>${record.attendeeInfo?.fullName || 'Unknown'}</td>
                    <td>${record.meetingId?.title || 'Meeting'}</td>
                    <td>${typeBadge}</td>
                    <td>${timeStr}</td>
                    <td>${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Update meeting filter dropdown
        function updateMeetingFilter(meetings) {
            const select = document.getElementById('attendanceMeetingFilter');
            if (!select) return;
            
            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            if (meetings && meetings.length > 0) {
                meetings.forEach(meeting => {
                    const option = document.createElement('option');
                    option.value = meeting._id;
                    option.textContent = meeting.title;
                    select.appendChild(option);
                });
            }
        }
        
        // Update attendance chart
        function updateAttendanceChart(byType) {
            const ctx = document.getElementById('attendanceChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (attendanceChart) {
                attendanceChart.destroy();
            }
            
            // Prepare data
            const labels = [];
            const data = [];
            const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#f8961e'];
            
            if (byType && byType.length > 0) {
                byType.forEach((type, index) => {
                    let label;
                    switch(type._id) {
                        case 'smartphone_gps': label = 'GPS'; break;
                        case 'sms': label = 'SMS'; break;
                        case 'ussd': label = 'USSD'; break;
                        case 'kiosk': label = 'Kiosk'; break;
                        case 'manual': label = 'Manual'; break;
                        default: label = type._id;
                    }
                    
                    labels.push(label);
                    data.push(type.count);
                });
            }
            
            // Create chart
            attendanceChart = new Chart(ctx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels.length > 0 ? labels : ['No Data'],
                    datasets: [{
                        data: data.length > 0 ? data : [1],
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = 'toast-custom';
            toast.style.animation = 'slideInRight 0.3s ease';
            
            // Set icon based on type
            let icon = 'info-circle';
            let bgColor = '#4361ee';
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    bgColor = '#4cc9f0';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    bgColor = '#f72585';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    bgColor = '#f8961e';
                    break;
            }
            
            toast.innerHTML = `
                <div class="toast-header-custom">
                    <div>
                        <i class="fas fa-${icon} me-2" style="color: ${bgColor}"></i>
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body-custom">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Helper function to get initials from name
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
        
        // Helper function to format date for datetime-local input
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // Placeholder functions for actions
        function startMeeting(meetingId) {
            showToast('Starting meeting... This would call the API in production', 'info');
        }
        
        function viewAttendanceDetails(attendanceId) {
            showToast('Viewing attendance details... This would show a modal with details', 'info');
        }
        
        function verifyAttendance(attendanceId) {
            showToast('Verifying attendance... This would call the API', 'info');
        }
        
        function rejectAttendance(attendanceId) {
            if (confirm('Are you sure you want to reject this attendance?')) {
                showToast('Rejecting attendance... This would call the API', 'info');
            }
        }
        
        function editAdmin(adminId) {
            showToast('Editing admin... This would show an edit modal', 'info');
        }
        
        function deleteAdmin(adminId) {
            if (confirm('Are you sure you want to delete this admin?')) {
                showToast('Deleting admin... This would call the API', 'info');
            }
        }
    </script>
</body>
</html>