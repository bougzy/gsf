<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSAMS - GeoSecure Attendance Management System</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <!-- QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        /* ... (Keep all your existing CSS styles) ... */
        
        /* New styles for unified meeting creation */
        .meeting-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid #eee;
            box-shadow: var(--box-shadow);
        }
        
        .meeting-section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .section-collapse-btn {
            float: right;
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .form-preview-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border: 2px dashed #dee2e6;
            min-height: 200px;
        }
        
        .advanced-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }
        
        .setting-group {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
        }
        
        .setting-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 50px;
            border: 1px solid #dee2e6;
            margin-bottom: 0.5rem;
        }
        
        /* Status indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-draft { background-color: #6c757d; }
        .status-active { background-color: #198754; }
        .status-in-progress { background-color: #0d6efd; }
        .status-completed { background-color: #6f42c1; }
        .status-cancelled { background-color: #dc3545; }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .advanced-settings-grid {
                grid-template-columns: 1fr;
            }
            
            .meeting-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="spinner-container">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Home Page (Keep existing) -->
    <div id="homePage">
        <!-- ... (Keep existing home page content) ... -->
    </div>

    <!-- Register Page (Keep existing) -->
    <div id="registerPage" class="auth-container" style="display: none;">
        <!-- ... (Keep existing register page) ... -->
    </div>

    <!-- Login Page (Keep existing) -->
    <div id="loginPage" class="auth-container" style="display: none;">
        <!-- ... (Keep existing login page) ... -->
    </div>

    <!-- Dashboard -->
    <div id="dashboard" style="display: none;">
        <!-- Sidebar (Keep existing) -->
        <div class="sidebar" id="sidebar">
            <!-- ... (Keep existing sidebar) ... -->
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Top Bar (Keep existing) -->
            <div class="top-bar">
                <!-- ... (Keep existing top bar) ... -->
            </div>
            
            <!-- Dashboard Content -->
            <div id="dashboard-content">
                <!-- Dashboard Home (Keep existing) -->
                <div id="dashboard-home" class="dashboard-section">
                    <!-- ... (Keep existing dashboard home) ... -->
                </div>
                
                <!-- Meetings Section - UPDATED FOR UNIFIED VIEW -->
                <div id="meetings" class="dashboard-section" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Meetings Management</h4>
                        <button class="btn btn-primary-custom" onclick="showCreateMeetingModal()">
                            <i class="fas fa-plus me-2"></i> Create New Meeting
                        </button>
                    </div>
                    
                    <!-- Meeting Filters -->
                    <div class="row mb-4">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="meetingStatusFilter" onchange="loadMeetings()">
                                    <option value="">All Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="active">Active</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="form-group">
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="meetingStartDate" onchange="loadMeetings()">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <div class="form-group">
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" id="meetingEndDate" onchange="loadMeetings()">
                            </div>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3 d-flex align-items-end">
                            <button class="btn btn-outline-custom w-100" onclick="resetMeetingFilters()">
                                <i class="fas fa-redo me-2"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- Meetings Table -->
                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Date & Time</th>
                                        <th>Location</th>
                                        <th>Methods</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="meetingsTable">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Other sections (Keep existing) -->
                <!-- ... (Keep existing attendance, reports, admins, settings, audit-logs sections) ... -->
            </div>
        </div>
    </div>

    <!-- ================= MODALS ================= -->
    
    <!-- Create Meeting Modal - UPDATED FOR UNIFIED VIEW -->
    <div class="modal fade" id="createMeetingModal" tabindex="-1" aria-labelledby="createMeetingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="createMeetingModalLabel">
                        <i class="fas fa-calendar-plus me-2"></i> Create New Meeting
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Progress Indicator -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">Meeting Creation Progress</small>
                            <small id="completionStatus" class="text-primary fw-bold">0% Complete</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="completionProgress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Unified Meeting Form -->
                    <form id="unifiedMeetingForm">
                        <!-- Section 1: Meeting Details -->
                        <div class="meeting-section" id="meetingDetailsSection">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="meeting-section-title">
                                    <i class="fas fa-info-circle me-2"></i> Meeting Details
                                </h5>
                                <button type="button" class="section-collapse-btn" onclick="toggleSection('meetingDetailsSection')">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            
                            <div id="meetingDetailsContent">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meeting Title *</label>
                                        <input type="text" class="form-control" id="meetingTitle" required 
                                               placeholder="Enter meeting title" oninput="updateCompletion()">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location Name *</label>
                                        <input type="text" class="form-control" id="meetingLocationName" required 
                                               placeholder="Enter location name" oninput="updateCompletion()">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="meetingDescription" rows="3" 
                                              placeholder="Enter meeting description" oninput="updateCompletion()"></textarea>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Start Date & Time *</label>
                                        <input type="datetime-local" class="form-control" id="meetingStartTime" 
                                               required onchange="updateCompletion()">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">End Date & Time *</label>
                                        <input type="datetime-local" class="form-control" id="meetingEndTime" 
                                               required onchange="updateCompletion()">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Latitude *</label>
                                        <input type="number" step="any" class="form-control" id="meetingLatitude" 
                                               required value="40.7128" placeholder="40.7128" oninput="updateCompletion()">
                                        <small class="text-muted">Placeholder: New York City latitude</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Longitude *</label>
                                        <input type="number" step="any" class="form-control" id="meetingLongitude" 
                                               required value="-74.0060" placeholder="-74.0060" oninput="updateCompletion()">
                                        <small class="text-muted">Placeholder: New York City longitude</small>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location Radius (meters) *</label>
                                        <input type="number" class="form-control" id="meetingRadius" value="100" 
                                               min="10" max="1000" required oninput="updateCompletion()">
                                        <small class="text-muted">Users must be within this radius to attend</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Location Address (Optional)</label>
                                        <input type="text" class="form-control" id="meetingAddress" 
                                               placeholder="Enter full address" oninput="updateCompletion()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 2: Attendance Form Settings -->
                        <div class="meeting-section" id="attendanceFormSection">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="meeting-section-title">
                                    <i class="fas fa-clipboard-list me-2"></i> Attendance Form Settings
                                </h5>
                                <button type="button" class="section-collapse-btn" onclick="toggleSection('attendanceFormSection')">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            
                            <div id="attendanceFormContent">
                                <div class="row">
                                    <div class="col-md-6 mb-4">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="requireForm" 
                                                   onchange="toggleFormBuilder()">
                                            <label class="form-check-label fw-bold" for="requireForm">
                                                Require custom attendance form
                                            </label>
                                        </div>
                                        
                                        <div id="formBuilderControls" style="display: none;">
                                            <h6 class="mb-3">Form Builder</h6>
                                            <div class="mb-3">
                                                <div id="formFieldsList">
                                                    <div class="alert alert-info">
                                                        <i class="fas fa-info-circle me-2"></i>
                                                        No fields added yet. Click "Add Field" to create form fields.
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex gap-2 mt-3">
                                                    <button type="button" class="btn btn-sm btn-outline-custom" onclick="addFormField()">
                                                        <i class="fas fa-plus me-1"></i> Add Field
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addDefaultFields()">
                                                        <i class="fas fa-magic me-1"></i> Default Fields
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-4">
                                        <div class="form-preview-container">
                                            <h6 class="mb-3">Form Preview</h6>
                                            <div id="formPreview">
                                                <p class="text-muted small">Form preview will appear here when fields are added</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Section 3: Advanced Settings -->
                        <div class="meeting-section" id="advancedSettingsSection">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="meeting-section-title">
                                    <i class="fas fa-cogs me-2"></i> Advanced Settings
                                </h5>
                                <button type="button" class="section-collapse-btn" onclick="toggleSection('advancedSettingsSection')">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            
                            <div id="advancedSettingsContent">
                                <div class="advanced-settings-grid">
                                    <!-- Attendance Methods -->
                                    <div class="setting-group">
                                        <h6 class="setting-group-title">
                                            <i class="fas fa-check-circle"></i> Attendance Methods
                                        </h6>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowGPSMeeting" checked>
                                            <label class="form-check-label" for="allowGPSMeeting">
                                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                                Smartphone GPS
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowSMSMeeting" checked>
                                            <label class="form-check-label" for="allowSMSMeeting">
                                                <i class="fas fa-sms me-2 text-info"></i>
                                                SMS
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowUSSDMeeting" checked>
                                            <label class="form-check-label" for="allowUSSDMeeting">
                                                <i class="fas fa-mobile-alt me-2 text-warning"></i>
                                                USSD
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowKioskMeeting" checked>
                                            <label class="form-check-label" for="allowKioskMeeting">
                                                <i class="fas fa-desktop me-2 text-secondary"></i>
                                                Kiosk
                                            </label>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="allowManualMeeting" checked>
                                            <label class="form-check-label" for="allowManualMeeting">
                                                <i class="fas fa-user-check me-2 text-success"></i>
                                                Manual
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Verification Settings -->
                                    <div class="setting-group">
                                        <h6 class="setting-group-title">
                                            <i class="fas fa-shield-alt"></i> Verification Settings
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label">Verification Strictness</label>
                                            <select class="form-select" id="verificationStrictness">
                                                <option value="low">Low - Lenient verification</option>
                                                <option value="medium" selected>Medium - Standard verification</option>
                                                <option value="high">High - Strict verification</option>
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Duplicate Prevention</label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="preventSameDevice" checked>
                                                <label class="form-check-label" for="preventSameDevice">
                                                    Prevent same device
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="preventSamePhone" checked>
                                                <label class="form-check-label" for="preventSamePhone">
                                                    Prevent same phone number
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="preventSameNameTime" checked>
                                                <label class="form-check-label" for="preventSameNameTime">
                                                    Prevent same name within time window
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Time Window (minutes)</label>
                                            <input type="number" class="form-control" id="duplicateTimeWindow" value="5" min="1" max="60">
                                        </div>
                                    </div>
                                    
                                    <!-- Time Verification -->
                                    <div class="setting-group">
                                        <h6 class="setting-group-title">
                                            <i class="fas fa-clock"></i> Time Verification
                                        </h6>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="requireMinimumStay" 
                                                   onchange="toggleMinimumStay()">
                                            <label class="form-check-label" for="requireMinimumStay">
                                                Require minimum stay duration
                                            </label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Minimum Stay (minutes)</label>
                                            <input type="number" class="form-control" id="minimumStayMinutes" 
                                                   value="5" min="1" max="120" disabled>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableContinuousMonitoring"
                                                   onchange="toggleContinuousMonitoring()">
                                            <label class="form-check-label" for="enableContinuousMonitoring">
                                                Enable continuous monitoring
                                            </label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Monitoring Interval (minutes)</label>
                                            <input type="number" class="form-control" id="monitoringInterval" 
                                                   value="5" min="1" max="30" disabled>
                                        </div>
                                    </div>
                                    
                                    <!-- PWA Settings -->
                                    <div class="setting-group">
                                        <h6 class="setting-group-title">
                                            <i class="fas fa-mobile-alt"></i> PWA Settings
                                        </h6>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="enablePWA" checked>
                                            <label class="form-check-label" for="enablePWA">
                                                Enable Progressive Web App
                                            </label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label">App Name</label>
                                            <input type="text" class="form-control" id="appName" value="GSAMS Attendance">
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Theme Color</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       id="themeColor" value="#2196F3">
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Background Color</label>
                                                <input type="color" class="form-control form-control-color" 
                                                       id="backgroundColor" value="#ffffff">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Validation Summary -->
                        <div class="alert alert-info mt-4" id="validationSummary">
                            <i class="fas fa-info-circle me-2"></i>
                            Please complete all required sections before creating the meeting.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary-custom" onclick="validateAndCreateMeeting()" id="createMeetingBtn">
                        <i class="fas fa-calendar-plus me-2"></i> Create Meeting
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meeting Success Modal -->
    <div class="modal fade" id="meetingSuccessModal" tabindex="-1" aria-labelledby="meetingSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="meetingSuccessModalLabel">
                        <i class="fas fa-check-circle me-2"></i> Meeting Created Successfully!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                        <h4 id="successMeetingTitle"></h4>
                        <p class="text-muted">Meeting has been created and is ready to share</p>
                    </div>
                    
                    <div class="share-section">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="share-link-container">
                                    <h6><i class="fas fa-link me-2"></i> Meeting Link</h6>
                                    <p class="text-muted small mb-3">Share this link with attendees:</p>
                                    <div class="share-link" id="successGeneratedLink">
                                        <span class="text-muted">Loading...</span>
                                    </div>
                                    <div class="mt-3 d-flex gap-2">
                                        <button class="btn btn-sm btn-primary-custom" onclick="copySuccessMeetingLink()">
                                            <i class="fas fa-copy me-1"></i> Copy Link
                                        </button>
                                        <button class="btn btn-sm btn-outline-custom" onclick="testSuccessMeetingLink()">
                                            <i class="fas fa-external-link-alt me-1"></i> Test Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-4">
                                <div class="qr-code-container">
                                    <h6><i class="fas fa-qrcode me-2"></i> QR Code</h6>
                                    <p class="text-muted small mb-3">Scan to join:</p>
                                    <div id="successQrCodeCanvas" class="d-flex justify-content-center"></div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-primary-custom" onclick="downloadSuccessQRCode()">
                                            <i class="fas fa-download me-1"></i> Download QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-key me-2"></i> Access Codes
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6>SMS Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successSmsCode"></code>
                                                <small class="text-muted">Text: ATTEND [CODE] [NAME]</small>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>USSD Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successUssdCode"></code>
                                                <small class="text-muted">Dial *123*[CODE]#</small>
                                            </div>
                                            <div class="col-md-4">
                                                <h6>Public Code</h6>
                                                <code class="d-block p-2 bg-light rounded" id="successPublicCode"></code>
                                                <small class="text-muted">For QR code & web link</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6><i class="fas fa-share-alt me-2"></i> Share Meeting</h6>
                            <div class="d-flex gap-2 mt-3">
                                <button class="btn btn-outline-primary" onclick="shareSuccessViaEmail()">
                                    <i class="fas fa-envelope me-1"></i> Email
                                </button>
                                <button class="btn btn-outline-info" onclick="shareSuccessViaWhatsApp()">
                                    <i class="fab fa-whatsapp me-1"></i> WhatsApp
                                </button>
                                <button class="btn btn-outline-secondary" onclick="shareSuccessViaSMS()">
                                    <i class="fas fa-sms me-1"></i> SMS
                                </button>
                                <button class="btn btn-outline-success" onclick="copyAllCodes()">
                                    <i class="fas fa-copy me-1"></i> Copy All Codes
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-primary-custom me-2" onclick="viewMeetingDashboard()">
                            <i class="fas fa-tachometer-alt me-1"></i> Go to Dashboard
                        </button>
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meeting Details Modal -->
    <div class="modal fade" id="meetingDetailsModal" tabindex="-1" aria-labelledby="meetingDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="meetingDetailsModalLabel">Meeting Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="meetingDetailsContent">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Meeting Modal -->
    <div class="modal fade" id="editMeetingModal" tabindex="-1" aria-labelledby="editMeetingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content modal-custom">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title" id="editMeetingModalLabel">Edit Meeting</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="editMeetingContent">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- AOS Animation Library -->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Main JavaScript -->
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true
        });
        
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentOrganization = null;
        let attendanceChart = null;
        let currentMeetingFormFields = [];
        let generatedMeetingLink = '';
        let generatedQRCode = '';
        let currentMeetingCode = '';
        let currentMeetingData = null;
        let editingMeetingId = null;
        
        // API Base URL
        const API_BASE_URL = 'https://gsb-hrs3.onrender.com/api';
        const FRONTEND_URL = window.location.origin;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Hide loading spinner
            setTimeout(() => {
                document.getElementById('loadingSpinner').style.display = 'none';
            }, 1000);
            
            // Check if user is already logged in
            checkAuthStatus();
            
            // Setup form submissions
            setupForms();
            
            // Setup navbar scroll effect
            setupNavbarScroll();
            
            // Setup sidebar toggle
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            
            // Initialize form builder
            initializeFormBuilder();
            
            // Setup advanced settings interactions
            setupAdvancedSettings();
            
            // Close sidebar when clicking overlay
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(event) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const toggleBtn = document.getElementById('toggleSidebar');
                
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target) && 
                        sidebar.classList.contains('active')) {
                        closeSidebar();
                    }
                }
            });
            
            // Set default date/times for meeting form
            setDefaultDateTime();
        });
        
        // Set default date/time for meeting form
        function setDefaultDateTime() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0); // 9:00 AM tomorrow
            
            const endTime = new Date(tomorrow);
            endTime.setHours(11, 0, 0, 0); // 11:00 AM tomorrow
            
            // Format for datetime-local input
            const formatDateTimeLocal = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            if (document.getElementById('meetingStartTime')) {
                document.getElementById('meetingStartTime').value = formatDateTimeLocal(tomorrow);
                document.getElementById('meetingEndTime').value = formatDateTimeLocal(endTime);
            }
        }
        
        // Setup advanced settings interactions
        function setupAdvancedSettings() {
            // Time verification toggles
            const requireMinimumStay = document.getElementById('requireMinimumStay');
            const enableContinuousMonitoring = document.getElementById('enableContinuousMonitoring');
            
            if (requireMinimumStay) {
                requireMinimumStay.addEventListener('change', function() {
                    document.getElementById('minimumStayMinutes').disabled = !this.checked;
                    updateCompletion();
                });
            }
            
            if (enableContinuousMonitoring) {
                enableContinuousMonitoring.addEventListener('change', function() {
                    document.getElementById('monitoringInterval').disabled = !this.checked;
                    updateCompletion();
                });
            }
            
            // Update completion when any setting changes
            document.querySelectorAll('#advancedSettingsContent input, #advancedSettingsContent select').forEach(element => {
                element.addEventListener('change', updateCompletion);
            });
        }
        
        // Toggle form builder visibility
        function toggleFormBuilder() {
            const requireForm = document.getElementById('requireForm');
            const formBuilderControls = document.getElementById('formBuilderControls');
            
            if (requireForm.checked) {
                formBuilderControls.style.display = 'block';
                updateFormPreview();
            } else {
                formBuilderControls.style.display = 'none';
                currentMeetingFormFields = [];
                updateFormPreview();
            }
            updateCompletion();
        }
        
        // Toggle minimum stay settings
        function toggleMinimumStay() {
            const requireMinimumStay = document.getElementById('requireMinimumStay');
            document.getElementById('minimumStayMinutes').disabled = !requireMinimumStay.checked;
        }
        
        // Toggle continuous monitoring settings
        function toggleContinuousMonitoring() {
            const enableContinuousMonitoring = document.getElementById('enableContinuousMonitoring');
            document.getElementById('monitoringInterval').disabled = !enableContinuousMonitoring.checked;
        }
        
        // Toggle section collapse
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('div[id$="Content"]');
            const button = section.querySelector('.section-collapse-btn i');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                button.className = 'fas fa-chevron-down';
            }
        }
        
        // Update completion percentage
        function updateCompletion() {
            let completed = 0;
            let total = 0;
            
            // Meeting Details Section
            total += 7; // 7 required fields
            
            const title = document.getElementById('meetingTitle')?.value.trim();
            const locationName = document.getElementById('meetingLocationName')?.value.trim();
            const startTime = document.getElementById('meetingStartTime')?.value;
            const endTime = document.getElementById('meetingEndTime')?.value;
            const latitude = document.getElementById('meetingLatitude')?.value;
            const longitude = document.getElementById('meetingLongitude')?.value;
            const radius = document.getElementById('meetingRadius')?.value;
            
            if (title) completed++;
            if (locationName) completed++;
            if (startTime) completed++;
            if (endTime) completed++;
            if (latitude) completed++;
            if (longitude) completed++;
            if (radius) completed++;
            
            // Attendance Form Section
            total += 1;
            const requireForm = document.getElementById('requireForm')?.checked;
            if (!requireForm) {
                completed++; // Not required, so counts as completed
            } else {
                total += 1; // Add another check for form fields
                if (currentMeetingFormFields.length > 0) completed += 2;
                else completed += 1; // Only the checkbox is checked
            }
            
            // Advanced Settings Section
            total += 1; // At least one attendance method
            
            const hasAttendanceMethod = 
                document.getElementById('allowGPSMeeting')?.checked ||
                document.getElementById('allowSMSMeeting')?.checked ||
                document.getElementById('allowUSSDMeeting')?.checked ||
                document.getElementById('allowKioskMeeting')?.checked ||
                document.getElementById('allowManualMeeting')?.checked;
            
            if (hasAttendanceMethod) completed++;
            
            // Calculate percentage
            const percentage = Math.round((completed / total) * 100);
            
            // Update UI
            document.getElementById('completionProgress').style.width = percentage + '%';
            document.getElementById('completionStatus').textContent = percentage + '% Complete';
            
            // Update validation summary
            const validationSummary = document.getElementById('validationSummary');
            if (percentage === 100) {
                validationSummary.className = 'alert alert-success mt-4';
                validationSummary.innerHTML = '<i class="fas fa-check-circle me-2"></i> All sections completed! Ready to create meeting.';
            } else if (percentage >= 75) {
                validationSummary.className = 'alert alert-warning mt-4';
                validationSummary.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Almost there! Complete remaining sections.';
            } else {
                validationSummary.className = 'alert alert-info mt-4';
                validationSummary.innerHTML = '<i class="fas fa-info-circle me-2"></i> Please complete all required sections before creating the meeting.';
            }
            
            return percentage;
        }
        
        // Initialize form builder
        function initializeFormBuilder() {
            currentMeetingFormFields = [];
            updateFormPreview();
        }
        
        // Add form field
        function addFormField(type = 'text', label = '', placeholder = '', required = false, options = []) {
            const fieldId = 'field_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const field = {
                id: fieldId,
                type: type || 'text',
                label: label || 'New Field',
                placeholder: placeholder || 'Enter value',
                required: required || false,
                options: options || []
            };
            
            currentMeetingFormFields.push(field);
            renderFormField(field);
            updateFormPreview();
            updateCompletion();
        }
        
        // Add default fields
        function addDefaultFields() {
            // Clear existing fields
            currentMeetingFormFields = [];
            document.getElementById('formFieldsList').innerHTML = '';
            
            // Add default fields
            addFormField('text', 'Full Name', 'Enter your full name', true);
            addFormField('email', 'Email Address', 'Enter your email address', false);
            addFormField('tel', 'Phone Number', 'Enter your phone number', true);
            addFormField('text', 'Employee/Student ID', 'Enter your ID number', false);
            addFormField('select', 'Department', 'Select your department', false, ['IT', 'HR', 'Finance', 'Operations', 'Marketing']);
            addFormField('textarea', 'Comments', 'Any additional comments', false);
            
            showToast('Default fields added successfully', 'success');
        }
        
        // Render form field in builder
        function renderFormField(field) {
            const fieldsList = document.getElementById('formFieldsList');
            
            // Remove the "no fields" message if it exists
            const alert = fieldsList.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
            
            const fieldElement = document.createElement('div');
            fieldElement.className = 'form-field-item';
            fieldElement.id = 'fieldItem_' + field.id;
            
            let optionsHTML = '';
            if (field.type === 'select' || field.type === 'radio' || field.type === 'checkbox') {
                optionsHTML = `
                    <div class="mt-2">
                        <small class="text-muted">Options (one per line):</small>
                        <textarea class="form-control form-control-sm" rows="2" onchange="updateFieldOptions('${field.id}', this.value)">${field.options.join('\n')}</textarea>
                    </div>
                `;
            }
            
            fieldElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${field.label} <span class="badge bg-secondary">${field.type}</span></h6>
                        <small class="text-muted">${field.placeholder}</small>
                        ${field.required ? '<span class="badge bg-danger ms-2">Required</span>' : ''}
                    </div>
                    <div class="field-actions">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editField('${field.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeField('${field.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${optionsHTML}
            `;
            
            fieldsList.appendChild(fieldElement);
        }
        
        // Update field options
        function updateFieldOptions(fieldId, optionsText) {
            const field = currentMeetingFormFields.find(f => f.id === fieldId);
            if (field) {
                field.options = optionsText.split('\n').filter(opt => opt.trim() !== '');
                updateFormPreview();
            }
        }
        
        // Edit field
        function editField(fieldId) {
            const field = currentMeetingFormFields.find(f => f.id === fieldId);
            if (!field) return;
            
            const newLabel = prompt('Enter field label:', field.label);
            if (newLabel === null) return;
            
            const newPlaceholder = prompt('Enter field placeholder:', field.placeholder);
            if (newPlaceholder === null) return;
            
            const isRequired = confirm('Is this field required?');
            
            field.label = newLabel;
            field.placeholder = newPlaceholder;
            field.required = isRequired;
            
            // Update the field element
            const fieldElement = document.getElementById('fieldItem_' + fieldId);
            if (fieldElement) {
                fieldElement.querySelector('h6').innerHTML = `${field.label} <span class="badge bg-secondary">${field.type}</span>`;
                fieldElement.querySelector('small').textContent = field.placeholder;
                
                const requiredBadge = fieldElement.querySelector('.badge.bg-danger');
                if (field.required && !requiredBadge) {
                    fieldElement.querySelector('h6').innerHTML += ' <span class="badge bg-danger">Required</span>';
                } else if (!field.required && requiredBadge) {
                    requiredBadge.remove();
                }
            }
            
            updateFormPreview();
            showToast('Field updated successfully', 'success');
        }
        
        // Remove field
        function removeField(fieldId) {
            if (!confirm('Are you sure you want to remove this field?')) return;
            
            currentMeetingFormFields = currentMeetingFormFields.filter(f => f.id !== fieldId);
            const fieldElement = document.getElementById('fieldItem_' + fieldId);
            if (fieldElement) {
                fieldElement.remove();
            }
            
            // Show "no fields" message if list is empty
            if (currentMeetingFormFields.length === 0) {
                const fieldsList = document.getElementById('formFieldsList');
                fieldsList.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No fields added yet. Click "Add Field" to create your first form field.</div>';
            }
            
            updateFormPreview();
            showToast('Field removed successfully', 'success');
            updateCompletion();
        }
        
        // Update form preview
        function updateFormPreview() {
            const preview = document.getElementById('formPreview');
            
            if (currentMeetingFormFields.length === 0) {
                preview.innerHTML = '<p class="text-muted small">No fields added yet</p>';
                return;
            }
            
            let previewHTML = '<form id="previewForm">';
            
            currentMeetingFormFields.forEach((field, index) => {
                let fieldHTML = '';
                
                switch(field.type) {
                    case 'text':
                    case 'email':
                    case 'tel':
                    case 'number':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <input type="${field.type}" class="form-control" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}>
                            </div>
                        `;
                        break;
                        
                    case 'textarea':
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <textarea class="form-control" rows="3" placeholder="${field.placeholder}" ${field.required ? 'required' : ''}></textarea>
                            </div>
                        `;
                        break;
                        
                    case 'select':
                        let optionsHTML = '<option value="">Select...</option>';
                        field.options.forEach(option => {
                            optionsHTML += `<option value="${option}">${option}</option>`;
                        });
                        
                        fieldHTML = `
                            <div class="mb-3">
                                <label class="form-label">${field.label} ${field.required ? '<span class="text-danger">*</span>' : ''}</label>
                                <select class="form-select" ${field.required ? 'required' : ''}>
                                    ${optionsHTML}
                                </select>
                            </div>
                        `;
                        break;
                }
                
                previewHTML += fieldHTML;
            });
            
            previewHTML += '<button type="submit" class="btn btn-primary-custom w-100">Submit Attendance</button></form>';
            preview.innerHTML = previewHTML;
        }
        
        // Validate and create meeting
        async function validateAndCreateMeeting() {
            try {
                // Validate meeting details
                if (!validateMeetingDetails()) {
                    showToast('Please fill in all required meeting details', 'error');
                    return;
                }
                
                // Validate at least one attendance method
                const hasAttendanceMethod = 
                    document.getElementById('allowGPSMeeting').checked ||
                    document.getElementById('allowSMSMeeting').checked ||
                    document.getElementById('allowUSSDMeeting').checked ||
                    document.getElementById('allowKioskMeeting').checked ||
                    document.getElementById('allowManualMeeting').checked;
                
                if (!hasAttendanceMethod) {
                    showToast('Please select at least one attendance method', 'error');
                    return;
                }
                
                // Validate form fields if required
                const requireForm = document.getElementById('requireForm').checked;
                if (requireForm && currentMeetingFormFields.length === 0) {
                    showToast('Form is required but no fields added. Please add at least one field.', 'error');
                    return;
                }
                
                // Create meeting
                await createMeeting();
                
            } catch (error) {
                console.error('Validation error:', error);
                showToast('Validation failed. Please check all fields.', 'error');
            }
        }
        
        // Validate meeting details
        function validateMeetingDetails() {
            const title = document.getElementById('meetingTitle').value.trim();
            const locationName = document.getElementById('meetingLocationName').value.trim();
            const startTime = document.getElementById('meetingStartTime').value;
            const endTime = document.getElementById('meetingEndTime').value;
            const latitude = document.getElementById('meetingLatitude').value;
            const longitude = document.getElementById('meetingLongitude').value;
            const radius = document.getElementById('meetingRadius').value;
            
            if (!title) {
                showToast('Meeting title is required', 'error');
                document.getElementById('meetingTitle').focus();
                return false;
            }
            
            if (!locationName) {
                showToast('Location name is required', 'error');
                document.getElementById('meetingLocationName').focus();
                return false;
            }
            
            if (!startTime) {
                showToast('Start time is required', 'error');
                document.getElementById('meetingStartTime').focus();
                return false;
            }
            
            if (!endTime) {
                showToast('End time is required', 'error');
                document.getElementById('meetingEndTime').focus();
                return false;
            }
            
            // Check if end time is after start time
            if (new Date(startTime) >= new Date(endTime)) {
                showToast('End time must be after start time', 'error');
                document.getElementById('meetingEndTime').focus();
                return false;
            }
            
            if (!latitude || !longitude) {
                showToast('Location coordinates are required', 'error');
                return false;
            }
            
            if (!radius || radius < 10 || radius > 1000) {
                showToast('Radius must be between 10 and 1000 meters', 'error');
                document.getElementById('meetingRadius').focus();
                return false;
            }
            
            return true;
        }
        
        // Create meeting
        async function createMeeting() {
            try {
                // Show loading state
                const createBtn = document.getElementById('createMeetingBtn');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Creating...';
                createBtn.disabled = true;
                
                // Gather meeting data
                const meetingData = {
                    title: document.getElementById('meetingTitle').value.trim(),
                    description: document.getElementById('meetingDescription').value.trim() || '',
                    location: {
                        name: document.getElementById('meetingLocationName').value.trim(),
                        latitude: parseFloat(document.getElementById('meetingLatitude').value),
                        longitude: parseFloat(document.getElementById('meetingLongitude').value),
                        radius: parseInt(document.getElementById('meetingRadius').value),
                        address: document.getElementById('meetingAddress')?.value.trim() || ''
                    },
                    schedule: {
                        startTime: document.getElementById('meetingStartTime').value,
                        endTime: document.getElementById('meetingEndTime').value,
                        bufferBefore: 30,
                        bufferAfter: 30
                    },
                    attendanceConfig: {
                        allowedModes: {
                            smartphoneGPS: document.getElementById('allowGPSMeeting').checked,
                            sms: document.getElementById('allowSMSMeeting').checked,
                            ussd: document.getElementById('allowUSSDMeeting').checked,
                            kiosk: document.getElementById('allowKioskMeeting').checked,
                            manual: document.getElementById('allowManualMeeting').checked
                        },
                        requiredFields: currentMeetingFormFields.filter(f => f.required).map(f => ({
                            field: f.label.toLowerCase().replace(/\s+/g, '_'),
                            isRequired: true
                        })),
                        verificationStrictness: document.getElementById('verificationStrictness').value,
                        duplicatePrevention: {
                            preventSameDevice: document.getElementById('preventSameDevice').checked,
                            preventSamePhone: document.getElementById('preventSamePhone').checked,
                            preventSameNameTime: document.getElementById('preventSameNameTime').checked,
                            timeWindowMinutes: parseInt(document.getElementById('duplicateTimeWindow').value) || 5
                        }
                    },
                    customFormFields: currentMeetingFormFields.map(field => ({
                        fieldName: field.label.toLowerCase().replace(/\s+/g, '_'),
                        fieldType: field.type,
                        label: field.label,
                        placeholder: field.placeholder,
                        options: field.options.map(opt => ({ value: opt, label: opt })),
                        isRequired: field.required,
                        order: currentMeetingFormFields.indexOf(field)
                    })),
                    timeVerification: {
                        requireMinimumStay: document.getElementById('requireMinimumStay').checked,
                        minimumStayMinutes: parseInt(document.getElementById('minimumStayMinutes').value) || 5,
                        enableContinuousMonitoring: document.getElementById('enableContinuousMonitoring').checked,
                        monitoringInterval: parseInt(document.getElementById('monitoringInterval').value) || 5,
                        maxAllowedAbsence: 2,
                        autoVerifyAfterStay: false,
                        autoVerifyMinutes: 10
                    },
                    pwaSettings: {
                        enablePWA: document.getElementById('enablePWA').checked,
                        appName: document.getElementById('appName').value,
                        themeColor: document.getElementById('themeColor').value,
                        backgroundColor: document.getElementById('backgroundColor').value
                    }
                };
                
                console.log('Creating meeting with data:', meetingData);
                
                const response = await fetch(`${API_BASE_URL}/meetings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(meetingData)
                });
                
                if (response.ok) {
                    const meeting = await response.json();
                    
                    // Store meeting data for success modal
                    currentMeetingData = meeting;
                    
                    // Close create meeting modal
                    const createModal = bootstrap.Modal.getInstance(document.getElementById('createMeetingModal'));
                    createModal.hide();
                    
                    // Reset form
                    resetMeetingForm();
                    
                    // Show success modal with QR code and link
                    showMeetingSuccessModal(meeting);
                    
                    // Reload meetings list
                    loadMeetings();
                    loadUpcomingMeetings();
                    loadDashboardData();
                    
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to create meeting', 'error');
                }
            } catch (error) {
                console.error('Create meeting error:', error);
                showToast('Failed to create meeting. Please try again.', 'error');
            } finally {
                // Reset button state
                const createBtn = document.getElementById('createMeetingBtn');
                createBtn.innerHTML = '<i class="fas fa-calendar-plus me-2"></i> Create Meeting';
                createBtn.disabled = false;
            }
        }
        
        // Reset meeting form
        function resetMeetingForm() {
            // Reset form fields
            document.getElementById('unifiedMeetingForm').reset();
            currentMeetingFormFields = [];
            document.getElementById('formFieldsList').innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>No fields added yet. Click "Add Field" to create your first form field.</div>';
            updateFormPreview();
            
            // Reset advanced settings
            document.getElementById('verificationStrictness').value = 'medium';
            document.getElementById('preventSameDevice').checked = true;
            document.getElementById('preventSamePhone').checked = true;
            document.getElementById('preventSameNameTime').checked = true;
            document.getElementById('duplicateTimeWindow').value = '5';
            document.getElementById('requireMinimumStay').checked = false;
            document.getElementById('minimumStayMinutes').disabled = true;
            document.getElementById('minimumStayMinutes').value = '5';
            document.getElementById('enableContinuousMonitoring').checked = false;
            document.getElementById('monitoringInterval').disabled = true;
            document.getElementById('monitoringInterval').value = '5';
            document.getElementById('enablePWA').checked = true;
            document.getElementById('appName').value = 'GSAMS Attendance';
            document.getElementById('themeColor').value = '#2196F3';
            document.getElementById('backgroundColor').value = '#ffffff';
            
            // Set default date/times
            setDefaultDateTime();
            
            // Reset completion status
            updateCompletion();
        }
        
        // Show meeting success modal
        function showMeetingSuccessModal(meeting) {
            // Update modal content with meeting data
            document.getElementById('successMeetingTitle').textContent = meeting.title;
            document.getElementById('successSmsCode').textContent = meeting.accessCodes?.smsCode || 'N/A';
            document.getElementById('successUssdCode').textContent = meeting.accessCodes?.ussdCode || 'N/A';
            document.getElementById('successPublicCode').textContent = meeting.accessCodes?.publicCode || 'N/A';
            
            // Generate meeting link
            const meetingLink = `${FRONTEND_URL}/attend/${meeting.accessCodes?.publicCode}`;
            generatedMeetingLink = meetingLink;
            
            // Display the link
            document.getElementById('successGeneratedLink').innerHTML = `
                <a href="${meetingLink}" target="_blank" class="text-decoration-none">${meetingLink}</a>
            `;
            
            // Generate QR code
            generateSuccessQRCode(meetingLink);
            
            // Show modal
            const successModal = new bootstrap.Modal(document.getElementById('meetingSuccessModal'));
            successModal.show();
        }
        
        // Generate QR code for success modal
        function generateSuccessQRCode(text) {
            const qrContainer = document.getElementById('successQrCodeCanvas');
            qrContainer.innerHTML = '';
            
            QRCode.toCanvas(text, { width: 200, margin: 2, color: { dark: '#4361ee', light: '#ffffff' } }, function(error, canvas) {
                if (error) {
                    console.error('QR Code generation error:', error);
                    qrContainer.innerHTML = '<p class="text-danger">Failed to generate QR code</p>';
                    return;
                }
                
                canvas.className = 'qr-code-canvas';
                qrContainer.appendChild(canvas);
                generatedQRCode = canvas.toDataURL('image/png');
            });
        }
        
        // Copy meeting link to clipboard from success modal
        function copySuccessMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            navigator.clipboard.writeText(generatedMeetingLink).then(() => {
                showToast('Meeting link copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy link', 'error');
            });
        }
        
        // Test meeting link from success modal
        function testSuccessMeetingLink() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            window.open(generatedMeetingLink, '_blank');
            showToast('Opening meeting link in new tab', 'info');
        }
        
        // Download QR code from success modal
        function downloadSuccessQRCode() {
            if (!generatedQRCode) {
                showToast('No QR code available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'meeting';
            const filename = `qr-code-${meetingTitle.replace(/\s+/g, '-').toLowerCase()}.png`;
            
            const link = document.createElement('a');
            link.href = generatedQRCode;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('QR code downloaded successfully!', 'success');
        }
        
        // Share via Email from success modal
        function shareSuccessViaEmail() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const subject = `Join ${meetingTitle}`;
            const body = `You're invited to join ${meetingTitle}.\n\nJoin via: ${generatedMeetingLink}\n\nSMS Code: ${currentMeetingData?.accessCodes?.smsCode}\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}\n\nOr scan the attached QR code to join.`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;
        }
        
        // Share via WhatsApp from success modal
        function shareSuccessViaWhatsApp() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const text = `Join ${meetingTitle}:\n${generatedMeetingLink}\n\nSMS Code: ${currentMeetingData?.accessCodes?.smsCode}\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}`;
            
            const whatsappLink = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(whatsappLink, '_blank');
        }
        
        // Share via SMS from success modal
        function shareSuccessViaSMS() {
            if (!generatedMeetingLink) {
                showToast('No meeting link available', 'error');
                return;
            }
            
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const body = `Join ${meetingTitle}:\n${generatedMeetingLink}\n\nSMS: ATTEND ${currentMeetingData?.accessCodes?.smsCode} [YOUR NAME]\nUSSD Code: ${currentMeetingData?.accessCodes?.ussdCode}`;
            
            const smsLink = `sms:?body=${encodeURIComponent(body)}`;
            window.location.href = smsLink;
        }
        
        // Copy all codes from success modal
        function copyAllCodes() {
            const meetingTitle = currentMeetingData?.title || 'Meeting';
            const link = generatedMeetingLink || '';
            const smsCode = currentMeetingData?.accessCodes?.smsCode || 'N/A';
            const ussdCode = currentMeetingData?.accessCodes?.ussdCode || 'N/A';
            const publicCode = currentMeetingData?.accessCodes?.publicCode || 'N/A';
            
            const text = `${meetingTitle}\n\nMeeting Link: ${link}\nSMS Code: ${smsCode}\nUSSD Code: ${ussdCode}\nPublic Code: ${publicCode}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('All codes copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy codes', 'error');
            });
        }
        
        // View meeting dashboard
        function viewMeetingDashboard() {
            // Close success modal
            const successModal = bootstrap.Modal.getInstance(document.getElementById('meetingSuccessModal'));
            successModal.hide();
            
            // Navigate to meetings section
            showDashboardSection('meetings');
        }
        
        // Show create meeting modal
        function showCreateMeetingModal() {
            // Reset form
            resetMeetingForm();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('createMeetingModal'));
            modal.show();
        }
        
        // ================= MEETING MANAGEMENT FUNCTIONS =================
        
        // Load meetings
        async function loadMeetings() {
            try {
                const status = document.getElementById('meetingStatusFilter')?.value || '';
                const startDate = document.getElementById('meetingStartDate')?.value || '';
                const endDate = document.getElementById('meetingEndDate')?.value || '';
                
                let url = `${API_BASE_URL}/meetings`;
                const params = new URLSearchParams();
                
                if (status) params.append('status', status);
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                if (params.toString()) {
                    url += `?${params.toString()}`;
                }
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meetings = await response.json();
                    updateMeetingsTable(meetings);
                } else {
                    throw new Error('Failed to load meetings');
                }
            } catch (error) {
                console.error('Load meetings error:', error);
                showToast('Failed to load meetings', 'error');
                updateMeetingsTable([]);
            }
        }
        
        // Reset meeting filters
        function resetMeetingFilters() {
            document.getElementById('meetingStatusFilter').value = '';
            document.getElementById('meetingStartDate').value = '';
            document.getElementById('meetingEndDate').value = '';
            loadMeetings();
        }
        
        // Update meetings table
        function updateMeetingsTable(meetings) {
            const tbody = document.getElementById('meetingsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!meetings || meetings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-calendar-times fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No meetings found</p>
                            <button class="btn btn-sm btn-primary-custom" onclick="showCreateMeetingModal()">
                                Create Your First Meeting
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            meetings.forEach(meeting => {
                const row = document.createElement('tr');
                
                // Format date
                const startTime = new Date(meeting.schedule.startTime);
                const dateStr = startTime.toLocaleDateString() + ' ' + startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Get attendance methods
                const methods = [];
                if (meeting.attendanceConfig?.allowedModes?.smartphoneGPS) methods.push('GPS');
                if (meeting.attendanceConfig?.allowedModes?.sms) methods.push('SMS');
                if (meeting.attendanceConfig?.allowedModes?.ussd) methods.push('USSD');
                if (meeting.attendanceConfig?.allowedModes?.kiosk) methods.push('Kiosk');
                if (meeting.attendanceConfig?.allowedModes?.manual) methods.push('Manual');
                
                // Status badge
                let statusBadge;
                let statusClass;
                switch(meeting.status) {
                    case 'draft': 
                        statusBadge = 'Draft';
                        statusClass = 'status-draft';
                        break;
                    case 'active': 
                        statusBadge = 'Active';
                        statusClass = 'status-active';
                        break;
                    case 'in_progress': 
                        statusBadge = 'In Progress';
                        statusClass = 'status-in-progress';
                        break;
                    case 'completed': 
                        statusBadge = 'Completed';
                        statusClass = 'status-completed';
                        break;
                    case 'cancelled': 
                        statusBadge = 'Cancelled';
                        statusClass = 'status-cancelled';
                        break;
                    default: 
                        statusBadge = 'Unknown';
                        statusClass = 'status-draft';
                }
                
                row.innerHTML = `
                    <td>
                        <strong>${meeting.title}</strong>
                        ${meeting.description ? `<br><small class="text-muted">${meeting.description.substring(0, 50)}${meeting.description.length > 50 ? '...' : ''}</small>` : ''}
                    </td>
                    <td>${dateStr}</td>
                    <td>${meeting.location?.name || 'N/A'}</td>
                    <td>
                        ${methods.map(method => `<span class="verification-badge">${method}</span>`).join('')}
                    </td>
                    <td>
                        <span class="${statusClass}"></span>${statusBadge}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="viewMeetingDetails('${meeting._id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="startMeeting('${meeting._id}')" title="Start Meeting">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="editMeeting('${meeting._id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteMeeting('${meeting._id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // View meeting details
        async function viewMeetingDetails(meetingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meeting = await response.json();
                    
                    // Format meeting details
                    const startTime = new Date(meeting.schedule.startTime);
                    const endTime = new Date(meeting.schedule.endTime);
                    
                    const detailsHTML = `
                        <div class="row">
                            <div class="col-md-8">
                                <h4>${meeting.title}</h4>
                                ${meeting.description ? `<p class="text-muted">${meeting.description}</p>` : ''}
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-calendar-alt me-2"></i>Schedule</h6>
                                        <p><strong>Start:</strong> ${startTime.toLocaleString()}</p>
                                        <p><strong>End:</strong> ${endTime.toLocaleString()}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-map-marker-alt me-2"></i>Location</h6>
                                        <p><strong>Name:</strong> ${meeting.location.name}</p>
                                        <p><strong>Address:</strong> ${meeting.location.address || 'N/A'}</p>
                                        <p><strong>Radius:</strong> ${meeting.location.radius} meters</p>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-check-circle me-2"></i>Attendance Methods</h6>
                                        <ul class="list-unstyled">
                                            ${meeting.attendanceConfig?.allowedModes?.smartphoneGPS ? '<li><i class="fas fa-check text-success me-2"></i>Smartphone GPS</li>' : ''}
                                            ${meeting.attendanceConfig?.allowedModes?.sms ? '<li><i class="fas fa-check text-success me-2"></i>SMS</li>' : ''}
                                            ${meeting.attendanceConfig?.allowedModes?.ussd ? '<li><i class="fas fa-check text-success me-2"></i>USSD</li>' : ''}
                                            ${meeting.attendanceConfig?.allowedModes?.kiosk ? '<li><i class="fas fa-check text-success me-2"></i>Kiosk</li>' : ''}
                                            ${meeting.attendanceConfig?.allowedModes?.manual ? '<li><i class="fas fa-check text-success me-2"></i>Manual</li>' : ''}
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6><i class="fas fa-info-circle me-2"></i>Meeting Info</h6>
                                        <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(meeting.status)}">${meeting.status}</span></p>
                                        <p><strong>Created:</strong> ${new Date(meeting.createdAt).toLocaleDateString()}</p>
                                        <p><strong>Verification Strictness:</strong> ${meeting.attendanceConfig?.verificationStrictness || 'Medium'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-qrcode me-2"></i> QR Code
                                    </div>
                                    <div class="card-body text-center">
                                        <div id="detailsQrCode" class="mb-3"></div>
                                        ${meeting.accessCodes?.publicCode ? `
                                            <p class="small text-muted">Public Code: <code>${meeting.accessCodes.publicCode}</code></p>
                                            <a href="${FRONTEND_URL}/attend/${meeting.accessCodes.publicCode}" target="_blank" class="btn btn-sm btn-primary w-100">
                                                <i class="fas fa-external-link-alt me-1"></i> Open Attendance Link
                                            </a>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="card mt-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-key me-2"></i> Access Codes
                                    </div>
                                    <div class="card-body">
                                        <p class="small"><strong>SMS Code:</strong> <code>${meeting.accessCodes?.smsCode || 'N/A'}</code></p>
                                        <p class="small"><strong>USSD Code:</strong> <code>${meeting.accessCodes?.ussdCode || 'N/A'}</code></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('meetingDetailsContent').innerHTML = detailsHTML;
                    
                    // Generate QR code if available
                    if (meeting.accessCodes?.publicCode) {
                        const qrContainer = document.getElementById('detailsQrCode');
                        const meetingLink = `${FRONTEND_URL}/attend/${meeting.accessCodes.publicCode}`;
                        
                        QRCode.toCanvas(meetingLink, { width: 150, margin: 1 }, function(error, canvas) {
                            if (!error) {
                                qrContainer.innerHTML = '';
                                qrContainer.appendChild(canvas);
                            }
                        });
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('meetingDetailsModal'));
                    modal.show();
                    
                } else {
                    throw new Error('Failed to fetch meeting details');
                }
            } catch (error) {
                console.error('View meeting details error:', error);
                showToast('Failed to load meeting details', 'error');
            }
        }
        
        // Edit meeting
        async function editMeeting(meetingId) {
            try {
                editingMeetingId = meetingId;
                
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meeting = await response.json();
                    
                    // Populate edit form
                    const editHTML = `
                        <form id="editMeetingForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Meeting Title</label>
                                    <input type="text" class="form-control" id="editMeetingTitle" value="${meeting.title}" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Location Name</label>
                                    <input type="text" class="form-control" id="editMeetingLocation" value="${meeting.location.name}" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="editMeetingDescription" rows="3">${meeting.description || ''}</textarea>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editMeetingStatus">
                                        <option value="draft" ${meeting.status === 'draft' ? 'selected' : ''}>Draft</option>
                                        <option value="active" ${meeting.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="in_progress" ${meeting.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="completed" ${meeting.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        <option value="cancelled" ${meeting.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="button" class="btn btn-primary-custom" onclick="saveMeetingChanges()">
                                    <i class="fas fa-save me-2"></i> Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary ms-2" data-bs-dismiss="modal">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    `;
                    
                    document.getElementById('editMeetingContent').innerHTML = editHTML;
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('editMeetingModal'));
                    modal.show();
                    
                } else {
                    throw new Error('Failed to fetch meeting details');
                }
            } catch (error) {
                console.error('Edit meeting error:', error);
                showToast('Failed to load meeting for editing', 'error');
            }
        }
        
        // Save meeting changes
        async function saveMeetingChanges() {
            try {
                const meetingData = {
                    title: document.getElementById('editMeetingTitle').value,
                    description: document.getElementById('editMeetingDescription').value,
                    location: {
                        name: document.getElementById('editMeetingLocation').value
                    },
                    status: document.getElementById('editMeetingStatus').value
                };
                
                const response = await fetch(`${API_BASE_URL}/meetings/${editingMeetingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(meetingData)
                });
                
                if (response.ok) {
                    showToast('Meeting updated successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editMeetingModal'));
                    modal.hide();
                    
                    // Reload meetings
                    loadMeetings();
                    
                } else {
                    throw new Error('Failed to update meeting');
                }
            } catch (error) {
                console.error('Save meeting changes error:', error);
                showToast('Failed to update meeting', 'error');
            }
        }
        
        // Start meeting
        async function startMeeting(meetingId) {
            try {
                if (!confirm('Are you sure you want to start this meeting?')) {
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showToast('Meeting started successfully!', 'success');
                    loadMeetings();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to start meeting', 'error');
                }
            } catch (error) {
                console.error('Start meeting error:', error);
                showToast('Failed to start meeting', 'error');
            }
        }
        
        // End meeting
        async function endMeeting(meetingId) {
            try {
                if (!confirm('Are you sure you want to end this meeting?')) {
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showToast('Meeting ended successfully!', 'success');
                    loadMeetings();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to end meeting', 'error');
                }
            } catch (error) {
                console.error('End meeting error:', error);
                showToast('Failed to end meeting', 'error');
            }
        }
        
        // Delete meeting
        async function deleteMeeting(meetingId) {
            try {
                if (!confirm('Are you sure you want to delete this meeting? This action cannot be undone.')) {
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/meetings/${meetingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    showToast('Meeting deleted successfully!', 'success');
                    loadMeetings();
                    loadDashboardData();
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to delete meeting', 'error');
                }
            } catch (error) {
                console.error('Delete meeting error:', error);
                showToast('Failed to delete meeting', 'error');
            }
        }
        
        // Get status badge class
        function getStatusBadgeClass(status) {
            switch(status) {
                case 'draft': return 'bg-secondary';
                case 'active': return 'bg-success';
                case 'in_progress': return 'bg-primary';
                case 'completed': return 'bg-info';
                case 'cancelled': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        // ================= AUTHENTICATION & HELPER FUNCTIONS =================
        
        // Check authentication status
        function checkAuthStatus() {
            const token = localStorage.getItem('gsams_token');
            const user = localStorage.getItem('gsams_user');
            
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showPage('dashboard');
                loadDashboardData();
            } else {
                showPage('home');
            }
        }
        
        // Setup form submissions
        function setupForms() {
            // Register form
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    registerUser();
                });
            }
            
            // Login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    loginUser();
                });
            }
        }
        
        // Setup navbar scroll effect
        function setupNavbarScroll() {
            window.addEventListener('scroll', function() {
                const navbar = document.querySelector('.navbar');
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        }
        
        // Show/hide pages
        function showPage(page) {
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            
            // Show selected page
            if (page === 'home') {
                document.getElementById('homePage').style.display = 'block';
                window.scrollTo(0, 0);
            } else if (page === 'register') {
                document.getElementById('registerPage').style.display = 'flex';
            } else if (page === 'login') {
                document.getElementById('loginPage').style.display = 'flex';
            } else if (page === 'dashboard') {
                document.getElementById('dashboard').style.display = 'block';
                loadDashboardData();
            }
        }
        
        // Show/hide dashboard sections
        function showDashboardSection(section) {
            // Close sidebar on mobile
            closeSidebar();
            
            // Hide all sections
            const sections = document.querySelectorAll('.dashboard-section');
            sections.forEach(sec => {
                sec.style.display = 'none';
            });
            
            // Update active menu item
            const menuItems = document.querySelectorAll('.sidebar-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            
            // Mark clicked item as active
            event.target.classList.add('active');
            
            // Show selected section
            document.getElementById(section).style.display = 'block';
            
            // Update page title
            const titles = {
                'dashboard-home': 'Dashboard',
                'meetings': 'Meetings',
                'attendance': 'Attendance',
                'reports': 'Reports',
                'admins': 'Admins',
                'settings': 'Settings',
                'audit-logs': 'Audit Logs'
            };
            
            document.getElementById('pageTitle').textContent = titles[section] || 'Dashboard';
            
            // Load section data
            if (section === 'meetings') {
                loadMeetings();
            } else if (section === 'attendance') {
                loadAttendance();
            } else if (section === 'admins') {
                loadAdmins();
            } else if (section === 'audit-logs') {
                loadAuditLogs();
            } else if (section === 'settings') {
                loadSettings();
            }
        }
        
        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            
            // Prevent body scroll when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = 'auto';
            }
        }
        
        // Close sidebar on mobile
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Register user
        async function registerUser() {
            const organizationName = document.getElementById('regOrganizationName').value;
            const fullName = document.getElementById('regFullName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password,
                        fullName,
                        phone,
                        organizationName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    authToken = data.token;
                    currentUser = data.user;
                    
                    localStorage.setItem('gsams_token', authToken);
                    localStorage.setItem('gsams_user', JSON.stringify(currentUser));
                    
                    showToast('Registration successful!', 'success');
                    showPage('dashboard');
                } else {
                    showToast(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showToast('Registration failed. Please try again.', 'error');
            }
        }
        
        // Login user
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Save token and user data
                    authToken = data.token;
                    currentUser = data.user;
                    
                    localStorage.setItem('gsams_token', authToken);
                    localStorage.setItem('gsams_user', JSON.stringify(currentUser));
                    
                    showToast('Login successful!', 'success');
                    showPage('dashboard');
                } else {
                    showToast(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please try again.', 'error');
            }
        }
        
        // Logout
        function logout() {
            localStorage.removeItem('gsams_token');
            localStorage.removeItem('gsams_user');
            authToken = null;
            currentUser = null;
            showToast('Logged out successfully', 'success');
            showPage('home');
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            if (!authToken) return;
            
            try {
                // Load dashboard stats
                const response = await fetch(`${API_BASE_URL}/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update stats
                    document.getElementById('totalMeetings').textContent = data.summary.totalMeetings || 0;
                    document.getElementById('activeMeetings').textContent = data.summary.activeMeetings || 0;
                    document.getElementById('totalAttendance').textContent = data.summary.totalAttendance || 0;
                    document.getElementById('todayAttendance').textContent = data.summary.todayAttendance || 0;
                    
                    // Update user info
                    document.getElementById('userName').textContent = currentUser.fullName;
                    document.getElementById('userRole').textContent = currentUser.role === 'super_admin' ? 'Super Admin' : 
                                                                     currentUser.role === 'admin' ? 'Admin' : 'Viewer';
                    document.getElementById('userAvatar').textContent = getInitials(currentUser.fullName);
                    
                    // Load upcoming meetings
                    loadUpcomingMeetings();
                    
                }
            } catch (error) {
                console.error('Dashboard data error:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }
        
        // Load upcoming meetings for dashboard
        async function loadUpcomingMeetings() {
            try {
                const now = new Date();
                const future = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                const response = await fetch(`${API_BASE_URL}/meetings?startDate=${now.toISOString()}&endDate=${future.toISOString()}&status=active`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const meetings = await response.json();
                    updateUpcomingMeetingsTable(meetings);
                }
            } catch (error) {
                console.error('Load upcoming meetings error:', error);
            }
        }
        
        // Update upcoming meetings table
        function updateUpcomingMeetingsTable(meetings) {
            const tbody = document.getElementById('upcomingMeetings');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!meetings || meetings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <i class="fas fa-calendar-plus fa-2x text-muted mb-3"></i>
                            <p class="text-muted">No upcoming meetings</p>
                            <button class="btn btn-sm btn-primary-custom" onclick="showCreateMeetingModal()">
                                Create Your First Meeting
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Show only first 5 meetings
            const displayMeetings = meetings.slice(0, 5);
            
            displayMeetings.forEach(meeting => {
                const row = document.createElement('tr');
                
                // Format date
                const startTime = new Date(meeting.schedule.startTime);
                const dateStr = startTime.toLocaleDateString() + ' ' + startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Status badge
                let statusBadge;
                switch(meeting.status) {
                    case 'draft': statusBadge = '<span class="badge bg-secondary">Draft</span>'; break;
                    case 'active': statusBadge = '<span class="badge bg-success">Active</span>'; break;
                    case 'in_progress': statusBadge = '<span class="badge bg-primary">In Progress</span>'; break;
                    default: statusBadge = '<span class="badge bg-secondary">Unknown</span>';
                }
                
                row.innerHTML = `
                    <td>${meeting.title}</td>
                    <td>${dateStr}</td>
                    <td>${meeting.location?.name || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewMeetingDetails('${meeting._id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="startMeeting('${meeting._id}')">
                            <i class="fas fa-play"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Load attendance (placeholder - implement as needed)
        async function loadAttendance() {
            // Implement attendance loading
            console.log('Loading attendance...');
        }
        
        // Load admins (placeholder - implement as needed)
        async function loadAdmins() {
            // Implement admins loading
            console.log('Loading admins...');
        }
        
        // Load audit logs (placeholder - implement as needed)
        async function loadAuditLogs() {
            // Implement audit logs loading
            console.log('Loading audit logs...');
        }
        
        // Load settings (placeholder - implement as needed)
        async function loadSettings() {
            // Implement settings loading
            console.log('Loading settings...');
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = 'toast-custom';
            toast.style.animation = 'slideInRight 0.3s ease';
            
            // Set icon based on type
            let icon = 'info-circle';
            let bgColor = '#4361ee';
            
            switch(type) {
                case 'success':
                    icon = 'check-circle';
                    bgColor = '#4cc9f0';
                    break;
                case 'error':
                    icon = 'exclamation-circle';
                    bgColor = '#f72585';
                    break;
                case 'warning':
                    icon = 'exclamation-triangle';
                    bgColor = '#f8961e';
                    break;
            }
            
            toast.innerHTML = `
                <div class="toast-header-custom">
                    <div>
                        <i class="fas fa-${icon} me-2" style="color: ${bgColor}"></i>
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body-custom">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }
        
        // Helper function to get initials from name
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }
    </script>
</body>
</html>